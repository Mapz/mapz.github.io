<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/link-300x300.gif">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/link-300x300.gif">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/link-300x300.gif">
  <link rel="mask-icon" href="/images/link-300x300.gif" color="#222">
  <link rel="manifest" href="/images/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Consolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"mapz.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="FIND THE CHILD">
<meta property="og:type" content="website">
<meta property="og:title" content="Mapz&#39;s Blog">
<meta property="og:url" content="http://mapz.github.io/page/2/index.html">
<meta property="og:site_name" content="Mapz&#39;s Blog">
<meta property="og:description" content="FIND THE CHILD">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Mapz">
<meta property="article:tag" content="游戏开发,UE4">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://mapz.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Mapz's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?69c67c43ced4b46e7ba1656a83e9c872";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Mapz's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">可以递归的函数指针</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://mapz.github.io/2021/05/25/UE4%EF%BC%9AUGameplayAbility%E7%B1%BB%E5%9E%8B%E7%AE%80%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/link-300x300.gif">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="FIND THE CHILD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/UE4%EF%BC%9AUGameplayAbility%E7%B1%BB%E5%9E%8B%E7%AE%80%E6%9E%90/" class="post-title-link" itemprop="url">UE4：UGameplayAbility 类型简析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-05-25 11:17:08 / 修改时间：17:17:55" itemprop="dateCreated datePublished" datetime="2021-05-25T11:17:08+08:00">2021-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>作为 GAS 系统中的核心元素之一 GameplayAbility 代表一个可大可小的 “能力”</p>
<p>这个能力能干啥，基本全靠你自己定义的边界，大到一个复杂的技能，小到一个动作，都可以作为一个“能力”</p>
<p>可以说 GA 的目的是基于一系列的行为控制来生成 GameplayEffect 改变 GameplayAttribue， 创建 GameplayCue 来处理显示和声音效果</p>
<p>这次我们基于 UE 版本 4.26 来简析一下 UGameplayAbility 类</p>
<h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><p>类型继承 UObject，并实现 IGameplayTaskOwnerInterface 接口</p>
<p>实现 IGameplayTaskOwnerInterface 的目的是为了可以在其中执行异步的 UGameplayTask</p>
<p>而 GA 使用的 GameplayTasksComponent 是 GA 的当前释放者的 AbilitySystemComponent （UAbilitySystemComponent 也是继承自 UGameplayTasksComponent 的）</p>
<h2 id="重要的函数"><a href="#重要的函数" class="headerlink" title="重要的函数"></a>重要的函数</h2><p>如源码中的注释所写的，GA 里面有几个重要的函数</p>
<h3 id="CanActivateAbility"><a href="#CanActivateAbility" class="headerlink" title="CanActivateAbility"></a>CanActivateAbility</h3><h4 id="函数定义"><a href="#函数定义" class="headerlink" title="函数定义"></a>函数定义</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">CanActivateAbility</span><span class="params">(<span class="keyword">const</span> FGameplayAbilitySpecHandle Handle, <span class="keyword">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="keyword">const</span> FGameplayTagContainer* SourceTags = <span class="literal">nullptr</span>, <span class="keyword">const</span> FGameplayTagContainer* TargetTags = <span class="literal">nullptr</span>, OUT FGameplayTagContainer* OptionalRelevantTags = <span class="literal">nullptr</span>)</span> <span class="keyword">const</span></span>;</span><br></pre></td></tr></table></figure>

<p>函数功能是检查是否可以激活此 Ability</p>
<p>GAS 中在 UAbilitySystemComponent::TryActivateAbility 中调用</p>
<ul>
<li>Handle 参数：AbilitySpcHandle，这个代表一个 Ability 的实例和数据载体的 Handle</li>
<li>ActorInfo 参数：当前技能的释放者信息，类型 FGameplayAbilityActorInfo 包括技能所有者，技能 Avatar Actor （代表物理上释放技能的 Actor，可以没有）和 PC ，骨架 Mesh ，是否本地 Actor 等信息</li>
<li>SourceTags：表示释放者拥有的 Tags</li>
<li>TargetTags：表示目标拥有的 Tags</li>
<li>OptionalRelevantTags：用来存放一些额外的信息，本体里面用来放技能释放失败的原因 Tags</li>
</ul>
<h4 id="函数默认流程"><a href="#函数默认流程" class="headerlink" title="函数默认流程"></a>函数默认流程</h4><p>函数是 virtual 的，你可以自己重写</p>
<p>默认流程如下</p>
<ol>
<li>判断是否符合执行策略（只能在服务器执行，只能在客户端发起之类的）</li>
<li>判断 ActorInfo 中是否含有 AbilitySystemComponent ，没有则不可以释放</li>
<li>判断用户是否禁止释放技能（AbilitySystemComponent.UserAbilityActivationInhibited，例如菜单状态下不能释放之类的)</li>
<li>判断技能冷却是否完成<blockquote>
<p>冷却是由 TSubclassOf<class UGameplayEffect> CooldownGameplayEffectClass 来控制的，在技能成功被 commit 的时候，会触发生成这个 GE，判断是否冷却了就是判断是否有这个 GE</p>
</blockquote>
</li>
<li>判断技能消费是否够<blockquote>
<p>同样的消费是由 TSubclassOf<class UGameplayEffect> CostGameplayEffectClass 来控制的，这个 GE 是懒加载的，这里会调用 AbilitySystemComponent-&gt;CanApplyAttributeModifiers 来检查是否有资源释放技能</p>
</blockquote>
</li>
<li>检查当前 Tags 是否满足释放条件，包括需要的 Tag，Block 的 Tag 等</li>
<li>获得技能实例的技能信息（FGameplayAbilitySpec）</li>
<li>如果绑定了输入，检查是否为不允许输入的技能（AbilitySystemComponent-&gt;IsAbilityInputBlocked）</li>
<li>检查蓝图覆盖的 K2_CanActivateAbility 是否可以释放</li>
</ol>
<h3 id="CallActivateAbility"><a href="#CallActivateAbility" class="headerlink" title="CallActivateAbility"></a>CallActivateAbility</h3><h4 id="函数定义-1"><a href="#函数定义-1" class="headerlink" title="函数定义"></a>函数定义</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CallActivateAbility</span><span class="params">(<span class="keyword">const</span> FGameplayAbilitySpecHandle Handle, <span class="keyword">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="keyword">const</span> FGameplayAbilityActivationInfo ActivationInfo, FOnGameplayAbilityEnded::FDelegate* OnGameplayAbilityEndedDelegate = <span class="literal">nullptr</span>, <span class="keyword">const</span> FGameplayEventData* TriggerEventData = <span class="literal">nullptr</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<p>函数用来激活 Ability</p>
<p>参数除了上面的以外还有</p>
<ul>
<li>ActivationInfo：FGameplayAbilityActivationInfo 类型，存储一些技能的激活信息，包括 PK 和 ActivationMode （激活的模式， Authority 或者 Client 等）</li>
<li>OnGameplayAbilityEndedDelegate： Ability Ended 回调</li>
<li>TriggerEventData：FGameplayEventData 类型，包括技能发起者，目标，目标数据，增幅，Tag容器等，还可以传入两个 Custom 的 UObject 用来传递数据</li>
</ul>
<h4 id="函数主要流程"><a href="#函数主要流程" class="headerlink" title="函数主要流程"></a>函数主要流程</h4><ol>
<li>执行 PreActivate（Virtual 可覆盖）<br> a. 刷新对齐 ServerMovement<br> b. 如果是实例化的 Activity，设置 bIsActive 为激活状态，设置为 bIsBlockingOtherAbilities 为 True<br> c. 设置 Activity 的当前 ActorInfo 和 ActivationInfo<br> d. 加入需要激活的 GameplayTags<br> e. 加入 AbilityEnded 回调<br> f. 发送 AbilityActivatedCallbacks 事件<br> g. 更新 Ability 的 Blocking 和 Cancel Tags</li>
<li>执行 ActivateAbility（Virtual 可覆盖）<br> a. 如果有蓝图实现，则使用蓝图实现 K2_ActivateAbility 激活任务<br> b. 如果有蓝图的 TriggerEvent 实现，则执行 K2_ActivateAbilityFromEvent(*TriggerEventData) 激活任务，灭有 TriggerData 则 End Ability<br> c. 如果没有蓝图实现，则直接 Commit Ability</li>
</ol>
<h3 id="CommitAbility"><a href="#CommitAbility" class="headerlink" title="CommitAbility"></a>CommitAbility</h3><h4 id="函数定义-2"><a href="#函数定义-2" class="headerlink" title="函数定义"></a>函数定义</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">CommitAbility</span><span class="params">(<span class="keyword">const</span> FGameplayAbilitySpecHandle Handle, <span class="keyword">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="keyword">const</span> FGameplayAbilityActivationInfo ActivationInfo, OUT FGameplayTagContainer* OptionalRelevantTags = <span class="literal">nullptr</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<p>函数是确认 Ability</p>
<h4 id="默认流程"><a href="#默认流程" class="headerlink" title="默认流程"></a>默认流程</h4><ol>
<li>调用 CommitCheck 检查是否可以 Commit （和 CanActivateAbility 差不多，也可以做额外的检查）</li>
<li>设置冷却，执行消耗资源 （ApplyCooldown 和 ApplyCost）</li>
<li>执行蓝图 K2_CommitExecute</li>
<li>发送 AbilityCommittedCallbacks 广播</li>
</ol>
<h3 id="CancelAbility"><a href="#CancelAbility" class="headerlink" title="CancelAbility"></a>CancelAbility</h3><h4 id="函数定义-3"><a href="#函数定义-3" class="headerlink" title="函数定义"></a>函数定义</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CancelAbility</span><span class="params">(<span class="keyword">const</span> FGameplayAbilitySpecHandle Handle, <span class="keyword">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="keyword">const</span> FGameplayAbilityActivationInfo ActivationInfo, <span class="keyword">bool</span> bReplicateCancelAbility)</span></span>;</span><br></pre></td></tr></table></figure>

<p>函数用来取消 Ability </p>
<h4 id="默认流程-1"><a href="#默认流程-1" class="headerlink" title="默认流程"></a>默认流程</h4><ol>
<li>检查 Ability 是否可以被 Cancel （如果是非实例化的，则可以被 Cancel，如果是实例化的，检查是否可以被 Cancel 的设置）</li>
<li>检查当前的 Ability 是否正在 ApplyGameplayEffectSpecToTarget （ScopeLockCount），如果正在被操作，加入 WaitingToExecute 中，并会在执行完成后，执行本次 Cancel 操作</li>
<li>如果需要，执行 ReplicateEndOrCancelAbility 执行客户端或者服务器的 CancelAbility 或者 EndAbility 的 RPC</li>
<li>广播 OnGameplayAbilityCancelled 事件</li>
<li>执行 EndAbility</li>
</ol>
<h3 id="EndAbility"><a href="#EndAbility" class="headerlink" title="EndAbility"></a>EndAbility</h3><h4 id="函数定义-4"><a href="#函数定义-4" class="headerlink" title="函数定义"></a>函数定义</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">EndAbility</span><span class="params">(<span class="keyword">const</span> FGameplayAbilitySpecHandle Handle, <span class="keyword">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="keyword">const</span> FGameplayAbilityActivationInfo ActivationInfo, <span class="keyword">bool</span> bReplicateEndAbility, <span class="keyword">bool</span> bWasCancelled)</span></span>;</span><br></pre></td></tr></table></figure>

<p>函数用来结束 Ability</p>
<h4 id="默认流程-2"><a href="#默认流程-2" class="headerlink" title="默认流程"></a>默认流程</h4><ol>
<li>检查 Ability 是否可以被 End<br> a. 不是 Active 的实例化 Acitivity 不可以被 End<br> b. 检查 Handle 的 ActivitySpec 是否 Active</li>
<li>查当前的 Ability 是否正在 ApplyGameplayEffectSpecToTarget （ScopeLockCount），如果正在被操作，加入 WaitingToExecute 中，并会在执行完成后，执行本次 EndAbility 操作</li>
<li>执行蓝图 K2_OnEndAbility</li>
<li>清除这个 Ability 在 World 中的所有 timer 和 latent actions</li>
<li>广播 OnGameplayAbilityEnded 事件，并移除回调</li>
<li>广播 OnGameplayAbilityEndedWithData 事件，并移除回调</li>
<li>对于实例化 Ability 设置 bIsActive 为非激活</li>
<li>结束所有挂在 Ability 上的 GameplayTask，并 Reset 列表来移除内存占用</li>
<li>如果需要执行 ReplicateEndOrCancelAbility</li>
<li>移除 ActivationTags</li>
<li>移除技能添加的 GameplayCue</li>
<li>移除 AbilityComponent 上的 Blocking 和 Cancel Tags</li>
<li>移除 PK 缓存</li>
<li>移除 AbilityComponent 上的 AnimatingAbility</li>
<li>播出 AbilityComponent 上的  AbilityEndedCallbacks ， OnAbilityEnded 事件</li>
<li>需要同步的 Ability ，移除 Spec 的 ReplicatedInstance（服务器）</li>
<li>不需要同步的 Ability ，移除 Spec 的 NonReplicatedInstances</li>
<li>服务器上如果没有活动的 Spec 则，且设置为在 Activation 后就从 Component 中移除 Ability 则 ClearAbility，否则 MarkAbilitySpecDirty</li>
</ol>
<p>这里的 ClearAbility，和 GiveAbility 对应，是从 AbilityComponent 中移除这个 Ability 的 Handle 而 MarkAbilitySpecDirty 是如字面意思表示 AbilitySpec 已经被修改过了</p>
<h2 id="配置项"><a href="#配置项" class="headerlink" title="配置项"></a>配置项</h2><ul>
<li>ReplicationPolicy：同步策略</li>
<li>InstancingPolicy：实例化策略，可以设置为非实例化，每个 Actor 实例化，或者每次执行实例化，非实例化的 Ability 只是用其 CDO 来做逻辑</li>
<li>bServerRespectsRemoteAbilityCancellation ： 是否可以从客户端来 Cancel 服务器上的 Ability</li>
<li>bRetriggerInstancedAbility：是否在激活一个实例化的 Ability 的时候， 先 End 再重新激活</li>
<li>NetExecutionPolicy：网络同步策略，包括本地预测，服务器 only 等</li>
<li>NetSecurityPolicy：网络安全政策，设置 Ability 的执行权限</li>
<li>CostGameplayEffectClass：消费的 GE</li>
<li>AbilityTriggers：可以激活 Ability 的 Tags</li>
<li>CooldownGameplayEffectClass：冷却的 GE</li>
<li>CancelAbilitiesWithTag：执行的时候，会 Cancel 含有这些 Tag 的其他 Ability</li>
<li>BlockAbilitiesWithTag：执行的时候，会 Block 含有这些 Tag 的其他 Ability</li>
<li>ActivationOwnedTags：激活的时候附加到 Owner 的 Tags</li>
<li>ActivationRequiredTags：激活的时候需要的 Tags</li>
<li>ActivationBlockedTags：激活的时候，如果有这些 Tags 会阻止激活</li>
<li>SourceRequiredTags：Source Actor 有这些 Tags 的时候才能激活</li>
<li>SourceBlockedTags：Source Actor 有这些 Tags 的时候不能激活</li>
<li>TargetRequiredTags：Target Actor 有这些 Tags 的时候才能激活</li>
<li>TargetBlockedTags：Target Actor 有这些 Tags 的时候不能激活</li>
<li>bReplicateInputDirectly: 是否直接把输入事件传到服务器</li>
<li>AbilityTags：拥有的 Tags，会同其他的 Ability 的 CancelAbilitiesWithTag 和 CancelAbilitiesWithTag 协同作用</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ol>
<li>非实例化的 Ability ，总是可以被 Cancel，也总是会 Block 其他的 Ability，而不需要设置</li>
<li>对于每个实例会不同的 Ability，需要设置为实例化，否则不要设置为实例化，以节省资源，Ability 所需的实例数据事实上存在 AbilitySpec 中</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://mapz.github.io/2021/05/20/UE4%EF%BC%9AC%E7%9B%98%E6%BB%A1%E4%BA%86%EF%BC%8C%E4%BF%AE%E6%94%B9DDC%E7%9B%AE%E5%BD%95%E7%9A%84%E4%BD%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/link-300x300.gif">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="FIND THE CHILD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/20/UE4%EF%BC%9AC%E7%9B%98%E6%BB%A1%E4%BA%86%EF%BC%8C%E4%BF%AE%E6%94%B9DDC%E7%9B%AE%E5%BD%95%E7%9A%84%E4%BD%8D%E7%BD%AE/" class="post-title-link" itemprop="url">UE4：C盘满了，修改DDC目录的位置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-20 11:09:10" itemprop="dateCreated datePublished" datetime="2021-05-20T11:09:10+08:00">2021-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-24 10:01:10" itemprop="dateModified" datetime="2021-05-24T10:01:10+08:00">2021-05-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>电脑上 C 盘空间太小，只有 100 G<br>其他盘的 SSD 也不够大，虚拟内存都快放不下了<br>打开 WinDirStat 一看 UE4 DDC 占了几十个 G 了<br>这就准备移动一下</p>
<ol>
<li>打开 UE4安装目录\Engine\Config\BaseEngine.ini</li>
<li>找到 InstalledDerivedDataBackendGraph 下的</li>
</ol>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Local</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, PurgeTransient=<span class="literal">true</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">34</span>, FoldersToClean=-<span class="number">1</span>, Path=<span class="string">&quot;%ENGINEVERSIONAGNOSTICUSERDIR%DerivedDataCache&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>修改 Path 到自己的目录即可</p>
<p>如果没有成功，可以修改环境变量</p>
<p>UE-LocalDataCachePath</p>
<p>值修改为自己的目录即可</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://mapz.github.io/2021/05/19/UE4%E5%AD%A6%E4%B9%A0%EF%BC%9AFPredictionKey/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/link-300x300.gif">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="FIND THE CHILD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/19/UE4%E5%AD%A6%E4%B9%A0%EF%BC%9AFPredictionKey/" class="post-title-link" itemprop="url">UE4学习：FPredictionKey</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-19 14:38:44" itemprop="dateCreated datePublished" datetime="2021-05-19T14:38:44+08:00">2021-05-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-28 11:45:42" itemprop="dateModified" datetime="2021-06-28T11:45:42+08:00">2021-06-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="FPredictionKey-的基本信息"><a href="#FPredictionKey-的基本信息" class="headerlink" title="FPredictionKey 的基本信息"></a>FPredictionKey 的基本信息</h2><p>FPredictionKey 是 UE4 在 Gameplay Ability System 插件中提供的一个结构体</p>
<p>编写目的是为了在 GAS 系统中实现客户端预测从而不用等待服务器返回提前就提前做一些操作</p>
<p>达到提高游戏流畅性的目的</p>
<p>服务器返回通过或者拒绝后，客户端可以相应的 Confirm 或者在 Reject 后回滚此次操作所做的修改</p>
<p>除了在 GAS 本身中</p>
<p>你也可以在其他需要客户端预测的地方使用</p>
<p>例如动画的预测</p>
<p>但是需要依赖 GAS 中的 UAbilitySystemComponent</p>
<ul>
<li>一个 Predication Key 可以看做是一个行为在服务器和客户端的唯一标识</li>
<li>Predication Key 的 ID 是全局唯一的，参考：</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FPredictionKey::GenerateNewPredictionKey</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// GKey 作为静态局部变量，其值为全局唯一，每次都 ++ </span></span><br><span class="line">    <span class="keyword">static</span> KeyType GKey = <span class="number">1</span>;</span><br><span class="line">    Current = GKey++;</span><br><span class="line">    <span class="keyword">if</span> (GKey &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        GKey = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    bIsStale = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在服务器上创建的 PK 则只作为一个行为的标识，不作为客户端预测用</p>
</li>
<li><p>PK 可以通过 void FPredictionKey::GenerateDependentPredictionKey() 创建依赖上一个 PK 的 PK ，但是不能在服务器执行，因为没有意义（无需预测就无需确认和回滚）</p>
</li>
<li><p>PK 可以通过 bIsStale 设置为是否可以在一次确认或拒绝后继续使用</p>
</li>
<li><p>PK 可以通过 NewRejectedDelegate 和 NewCaughtUpDelegate 来创建确认或者拒绝的回调，即是服务器同意或者拒绝客户端预测的时候所调用的回调</p>
</li>
<li><p>PK 的网络序列化是自定义的</p>
<ul>
<li>第一位是 PK 是否在当前 Connection 可用，在序列化的时候设置，如果是服务器创建的，则都可用，否则只有 PK 的连接信息和当前连接一致的时候可用<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ValidKeyForConnection = (PredictiveConnection == <span class="literal">nullptr</span> || (Map == PredictiveConnection) || bIsServerInitiated) &amp;&amp; (Current &gt; <span class="number">0</span>);</span><br></pre></td></tr></table></figure></li>
<li>第二位是是否有依赖的 PK （仅当当前 Connection 可用的时候可用）</li>
<li>第三位是是否为服务器创建</li>
<li>如果是可用连接，则写入当前的 PK ID</li>
<li>如果有依赖的 PK 则写入依赖 PK ID</li>
<li>如果是服务器创建的 PK 则设置当前 PK 的 Connection 为当前 Connection</li>
</ul>
</li>
</ul>
<h2 id="从-Activate-Ability-来看-PredicationKey-的使用"><a href="#从-Activate-Ability-来看-PredicationKey-的使用" class="headerlink" title="从 Activate Ability 来看 PredicationKey 的使用"></a>从 Activate Ability 来看 PredicationKey 的使用</h2><p>我们从 UAbilitySystemCompoment::TryActivateAbility 看起，这里仅讨论一种情况，就是客户端发起激活，服务器检查并确认的方式，略过其他方式的流程</p>
<ol>
<li>先判断技能是否可以被释放（是否已经被 Give To Actor）</li>
<li>判断技能释放的 Actor 是否合法</li>
<li>模拟端不可以释放技能，return</li>
<li>检查技能是否是客户端远程释放的，并检查是否可以远程释放，如果可以释放则 创建新的 PK 并调用 CallServerTryActivateAbility 准备执行服务器 RPC ServerTryActivateAbility</li>
<li>CallServerTryActivateAbility 中检查是否存在合批的 RPC 数据，如果合批的 RPC 数据未开始，则更新 PK 并开始，否则直接调用 服务器 RPC ServerTryActivateAbility ，并传入创建的 PK</li>
<li>Server 调用 InternalServerTryActivateAbility<br> a. Activate 失败的时候，调用客户端 RPC ，通知此 PK 调用失败，客户端调用此 PK 的拒绝委托，从而达到回滚等目的，并且执行 EndAbility<br> b. Activate 成功的时候，调用客户端 RPC ClientActivateAbilitySucceed 通知客户端激活 Ability 成功<br> c. 客户端和服务器在成功的时候，都会调用 CallActivateAbility 来启动 Activate Ability</li>
</ol>
<p>这个里面，一个 PredicationKey  通过 RPC 在客户端和服务器之间传递并储存，并且通过 RPC 通知执行成功或者失败，在成功和失败的时候，执行通过 PK 对应起来的成功和失败的委托</p>
<p>Activate Ability 并没有直接用到回滚相关的内容，因为这里没有在客户端 Try Activate Ability 后做其他操作，而是等待服务器返回 Confirm 或者 Reject</p>
<p>我们在释放技能后，也可以会做过一些附加操作，这些操作可以在 Reject 委托中绑定自己的回滚操作</p>
<p>写其他一些功能的时候，也可以直接在客户端发送 RPC 后，直接开始处理自己的操作，等待服务器 Reject 后，用挂在 Reject 的委托上，用于回滚客户端操作，例如停止播放动画</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://mapz.github.io/2021/05/17/UE4%EF%BC%9A%E6%B8%B8%E6%88%8F%E5%85%B3%E9%97%AD%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/link-300x300.gif">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="FIND THE CHILD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/17/UE4%EF%BC%9A%E6%B8%B8%E6%88%8F%E5%85%B3%E9%97%AD%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">UE4：游戏关闭流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-17 16:00:58" itemprop="dateCreated datePublished" datetime="2021-05-17T16:00:58+08:00">2021-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-25 11:15:51" itemprop="dateModified" datetime="2021-05-25T11:15:51+08:00">2021-05-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>有时候我们需要在 UE4 关闭游戏的时候，处理一些事情，那么可以重写 UGameInstance::ShutDown()</p>
<p>但是有时候在游戏关闭的时候，这个函数并未调用，于是我有必要探究一番他的调用链</p>
<p>这里仅讨论 Engine 而不讨论 EditorEngine</p>
<p>调用栈</p>
<ul>
<li>UGameInstance::ShutDown()</li>
<li>UGameEngine::PreExit()</li>
<li>FEngineLoop::Exit()</li>
<li>调用 EngineExit 或者平台调用退出</li>
<li>EngineExit 被放在了 GuardedMain 函数中定义的一个结构体中</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// make sure GEngineLoop::Exit() is always called.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">EngineLoopCleanupGuard</span> </span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">	~<span class="built_in">EngineLoopCleanupGuard</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">EngineExit</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125; CleanupGuard;</span><br></pre></td></tr></table></figure>

<p>也就是说游戏 Main 函数结束执行的时候，一定会执行 ShutDown</p>
<p>那么为什么我测试的时候日志中没有出现 ShutDown 相关内容呢</p>
<p>检查发现我们调用关闭游戏的时候用的是</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FPlatformMisc::<span class="built_in">RequestExit</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FWindowsPlatformMisc::RequestExit</span><span class="params">( <span class="keyword">bool</span> Force )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogWindows, Log,  <span class="built_in">TEXT</span>(<span class="string">&quot;FPlatformMisc::RequestExit(%i)&quot;</span>), Force );</span><br><span class="line"></span><br><span class="line">	<span class="built_in">RequestEngineExit</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Win RequestExit&quot;</span>));</span><br><span class="line">	FCoreDelegates::ApplicationWillTerminateDelegate.<span class="built_in">Broadcast</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( Force )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Force immediate exit. In case of an error set the exit code to 3.</span></span><br><span class="line">		<span class="comment">// Dangerous because config code isn&#x27;t flushed, global destructors aren&#x27;t called, etc.</span></span><br><span class="line">		<span class="comment">// Suppress abort message and MS reports.</span></span><br><span class="line">		<span class="comment">//_set_abort_behavior( 0, _WRITE_ABORT_MSG | _CALL_REPORTFAULT );</span></span><br><span class="line">		<span class="comment">//abort();</span></span><br><span class="line">	</span><br><span class="line">		<span class="comment">// Make sure the log is flushed.</span></span><br><span class="line">		<span class="keyword">if</span>( GLog )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// This may be called from other thread, so set this thread as the master.</span></span><br><span class="line">			GLog-&gt;<span class="built_in">SetCurrentThreadAsMasterThread</span>();</span><br><span class="line">			GLog-&gt;<span class="built_in">TearDown</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">TerminateProcess</span>(<span class="built_in">GetCurrentProcess</span>(), GIsCriticalError ? <span class="number">3</span> : <span class="number">0</span>); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Tell the platform specific code we want to exit cleanly from the main loop.</span></span><br><span class="line">		<span class="built_in">PostQuitMessage</span>( <span class="number">0</span> );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见传入 true 为参数的时候，直接把进程杀了，导致未执行 UGameInstance::ShutDown()</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://mapz.github.io/2019/01/17/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9A%E5%83%8F%E7%B4%A0FC%E8%BF%98%E5%8E%9F%E6%B8%B8%E6%88%8FSuperSimon%EF%BC%88%E4%B8%80%EF%BC%89%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/link-300x300.gif">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="FIND THE CHILD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/17/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9A%E5%83%8F%E7%B4%A0FC%E8%BF%98%E5%8E%9F%E6%B8%B8%E6%88%8FSuperSimon%EF%BC%88%E4%B8%80%EF%BC%89%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/" class="post-title-link" itemprop="url">Unity学习：像素FC还原游戏SuperSimon（一）准备工作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-17 16:44:09" itemprop="dateCreated datePublished" datetime="2019-01-17T16:44:09+08:00">2019-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-22 10:15:32" itemprop="dateModified" datetime="2021-04-22T10:15:32+08:00">2021-04-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>现在开始正式制作我们的FC重制游戏 SuperSimon</p>
<h2 id="创建环境"><a href="#创建环境" class="headerlink" title="创建环境"></a>创建环境</h2><ol>
<li>Unity 2018.3</li>
<li>使用 Package Manager 下载 2D Pixel Perfect 插件（需要设置 Package Manager 的高级设置，打开显示预览包</li>
<li>因为本次使用新的输入包，使用 Package Manager 下载 Input System</li>
<li>使用 <a href="https://mapz.github.io/2019/01/17/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AFC%E4%B8%AD%E6%8A%A0%E5%87%BA%E6%9D%A5%E7%9A%84%E5%AD%97%E4%BD%93%E5%81%9A%E6%88%90BitmapFont/">这里</a> 的文章中的方式，从恶魔城3的SpriteSheet中创建好字体</li>
</ol>
<img src="/2019/01/17/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9A%E5%83%8F%E7%B4%A0FC%E8%BF%98%E5%8E%9F%E6%B8%B8%E6%88%8FSuperSimon%EF%BC%88%E4%B8%80%EF%BC%89%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/CV3Font.png" class="" title="Dump的字体图片">

<h2 id="场景中的内容"><a href="#场景中的内容" class="headerlink" title="场景中的内容"></a>场景中的内容</h2><ol>
<li>摄像机设置正交，背景色 solid color,大小128</li>
<li>摄像机GO上添加一个 Pixel Perfect Camera，设置pixel perUnit 1,分辨率256 x 240,下面钩子全打上</li>
<li>创建UICanvas，用摄像机 Render，Pixel perfect 勾上，Canvas Scaler 分辨率设置好，模式选择随屏幕大小缩放。 pixel per unit 1。Match mode expand。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://mapz.github.io/2019/01/17/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AFC%E4%B8%AD%E6%8A%A0%E5%87%BA%E6%9D%A5%E7%9A%84%E5%AD%97%E4%BD%93%E5%81%9A%E6%88%90BitmapFont/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/link-300x300.gif">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="FIND THE CHILD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/17/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AFC%E4%B8%AD%E6%8A%A0%E5%87%BA%E6%9D%A5%E7%9A%84%E5%AD%97%E4%BD%93%E5%81%9A%E6%88%90BitmapFont/" class="post-title-link" itemprop="url">Unity学习：FC中抠出来的字体做成BitmapFont</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-17 16:12:22" itemprop="dateCreated datePublished" datetime="2019-01-17T16:12:22+08:00">2019-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-22 10:15:32" itemprop="dateModified" datetime="2021-04-22T10:15:32+08:00">2021-04-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>做像素游戏的时候，你通常会自定义字体，或者绘制像素字体。</p>
<p>字体画好，或者像我们一样直接从 FC 游戏里面抠出图集来之后，怎么样来做成BitmapFont呢？</p>
<p>网上的内容通常教你怎么从安装好的ttf来导出，现在我们手上只有 PNG 怎么办呢？</p>
<h2 id="用到的工具"><a href="#用到的工具" class="headerlink" title="用到的工具"></a>用到的工具</h2><ul>
<li>BMFont</li>
<li>Unity</li>
</ul>
<h2 id="假设"><a href="#假设" class="headerlink" title="假设"></a>假设</h2><ol>
<li>我们的字符图集中文字大小都是 8 X 8,并且无间隔（也可以是其他大小，总之Unity可以自动按格子大小来切就行）</li>
</ol>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol>
<li>我们从FC Dump 下来的字体图集，一般都是8x8的字符集，为了能够使用BMFont来导出Bitmap Font，我们需要先把这个图集打成单个的字符。</li>
<li>打开 Unity，导入字符集图片，导入设置为 压缩-&gt;无，并把可读写打开，Sprite类型为多个</li>
<li>打开 Sprite Editor ，切片方式 By Cell Size 大小 8 x 8，切好图集</li>
<li>使用如下脚本导出为单个的图片</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">using UnityEditor;</span><br><span class="line">using UnityEngine;</span><br><span class="line">static class BitmapFontTool &#123;</span><br><span class="line">    [MenuItem (&quot;BitmapFontTool/导出切好的Sprite&quot;)]</span><br><span class="line">    static void SaveSprite () &#123;</span><br><span class="line">        //每一张贴图类型Advanced下 Read/Write Enabled打上勾才能进行文件读取</span><br><span class="line">        //导入类型不能是压缩过的</span><br><span class="line">        string bitMapfontPath = @&quot;Assets/BitmapFontTool/&quot;;</span><br><span class="line">        foreach (Object obj in Selection.objects) &#123;</span><br><span class="line"></span><br><span class="line">            string selectionPath = AssetDatabase.GetAssetPath (obj);</span><br><span class="line">            string selectionExt = System.IO.Path.GetExtension (selectionPath);</span><br><span class="line">            string fileName = System.IO.Path.GetFileNameWithoutExtension (selectionPath);</span><br><span class="line">            string loadPath = selectionPath.Substring (0, selectionPath.Length - selectionExt.Length);</span><br><span class="line">            if (selectionExt.Length == 0) continue;</span><br><span class="line"></span><br><span class="line">            //加载此文件下的所有资源</span><br><span class="line">            Object[] spriteList = AssetDatabase.LoadAllAssetsAtPath (selectionPath); </span><br><span class="line"></span><br><span class="line">            if (spriteList.Length &gt; 0) &#123;</span><br><span class="line">                //创建导出文件夹</span><br><span class="line">                string outPath = bitMapfontPath + &quot;/SpriteExportOutput/&quot; + fileName;</span><br><span class="line">                System.IO.Directory.CreateDirectory (outPath);</span><br><span class="line"></span><br><span class="line">                foreach (var sprite in spriteList) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        var sprite_ = (Sprite) sprite;</span><br><span class="line">                        Texture2D tex = new Texture2D ((int) sprite_.rect.width, (int) sprite_.rect.height, sprite_.texture.format, false);</span><br><span class="line">                        tex.SetPixels (sprite_.texture.GetPixels ((int) sprite_.rect.xMin, (int) sprite_.rect.yMin, (int) sprite_.rect.width, (int) sprite_.rect.height));</span><br><span class="line">                        tex.Apply ();</span><br><span class="line">                        //写出成png文件</span><br><span class="line">                        System.IO.File.WriteAllBytes (outPath + &quot;/&quot; + sprite_.name + &quot;.png&quot;, tex.EncodeToPNG ());</span><br><span class="line">                        Debug.Log (&quot;SaveSprite to&quot; + outPath);</span><br><span class="line">                    &#125; catch (System.Exception e) &#123;</span><br><span class="line">                        Debug.Log (e);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                Debug.Log (&quot;保存图片完毕!&quot; + outPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>网上搜索 BMFont 教程，按教程使用导出的图片，创建 fnt 字体</li>
<li>把输出的文件导入 Unity ,下载 BitmapFontImporter 插件</li>
<li>Assets -&gt; Bitmap Font -&gt; build 创建 Unity 自定义字体</li>
<li>使用字体</li>
</ol>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><ol>
<li>BMFont 导入大量图片文件的时候非常的难用，不适合批量使用</li>
<li>既然已经有图集了，何不在图集上自己创建fnt文件呢？</li>
</ol>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>在Unity下，自己写个工具来制作fnt也并不难<br>挖个坑留着以后来尝试</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://mapz.github.io/2019/01/17/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9A%E5%BC%80%E6%96%B0%E5%9D%91%EF%BC%8CSuper-Simon-Adv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/link-300x300.gif">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="FIND THE CHILD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/17/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9A%E5%BC%80%E6%96%B0%E5%9D%91%EF%BC%8CSuper-Simon-Adv/" class="post-title-link" itemprop="url">Unity学习：开新坑，Super_Simon_Adv</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-17 11:00:16" itemprop="dateCreated datePublished" datetime="2019-01-17T11:00:16+08:00">2019-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-22 10:15:32" itemprop="dateModified" datetime="2021-04-22T10:15:32+08:00">2021-04-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前做了 FC 荒野大镖客的 retro demo</p>
<p>总结了一些问题，现在准备先放在一边，不想改了</p>
<p>根据总结的这些问题，开个新坑吧</p>
<p>准备弄成一个 FC 大杂烩游戏</p>
<h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><p>恶魔城西蒙的大冒险</p>
<p>素材为各个 FC 游戏内容</p>
<p>横版 Platform<br>根据可能 也会变成 横版清关</p>
<h2 id="分辨率"><a href="#分辨率" class="headerlink" title="分辨率"></a>分辨率</h2><p>还原 FC 的 256 X 240 分辨率</p>
<h2 id="预计用到的内容和改进"><a href="#预计用到的内容和改进" class="headerlink" title="预计用到的内容和改进"></a>预计用到的内容和改进</h2><ol>
<li>之前的 Demo 没有经过设计，想到哪写到哪，太潦草，所以这次先设计好再出发</li>
<li>这次使用 CSV 的方式来配置单位属性，并初始化</li>
<li>Pixel Perfect 摄像机</li>
<li>先弄成单机打包模式，后期再弄成可热更新模式</li>
<li>先期接入 Lua</li>
<li>使用 Unity 的 Preview 新输入方式</li>
<li>AI 使用 行为树</li>
<li>使用一些 Shader 来制作效果</li>
<li>生怪器的进一步优化</li>
<li>做一个从 PNG 导出 Bitmap Font 的工具</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://mapz.github.io/2018/12/11/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AProjectTiny%E7%8E%B0%E7%8A%B6%EF%BC%88%E5%8D%B3%E6%97%B6%E6%9B%B4%E6%96%B0%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/link-300x300.gif">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="FIND THE CHILD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/11/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AProjectTiny%E7%8E%B0%E7%8A%B6%EF%BC%88%E5%8D%B3%E6%97%B6%E6%9B%B4%E6%96%B0%EF%BC%89/" class="post-title-link" itemprop="url">Unity学习：ProjectTiny现状（即时更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-11 15:33:34" itemprop="dateCreated datePublished" datetime="2018-12-11T15:33:34+08:00">2018-12-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-22 10:15:32" itemprop="dateModified" datetime="2021-04-22T10:15:32+08:00">2021-04-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="TileMap"><a href="#TileMap" class="headerlink" title="TileMap"></a>TileMap</h2><ul>
<li>可以编辑，可以使用，但是现在无物理特性（Platform游戏可以先等等），不能设置碰撞</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://mapz.github.io/2018/12/10/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AProjectTiny%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%E5%BC%B9%E7%90%83%E5%92%8C2D%E7%89%A9%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/link-300x300.gif">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="FIND THE CHILD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/10/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AProjectTiny%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%E5%BC%B9%E7%90%83%E5%92%8C2D%E7%89%A9%E7%90%86/" class="post-title-link" itemprop="url">Unity学习：ProjectTiny学习（二）弹球和2D物理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-10 14:40:38" itemprop="dateCreated datePublished" datetime="2018-12-10T14:40:38+08:00">2018-12-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 18:01:14" itemprop="dateModified" datetime="2021-04-23T18:01:14+08:00">2021-04-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>接着上次我们继续来玩 Tiny Mode</p>
<h2 id="创建一个新项目"><a href="#创建一个新项目" class="headerlink" title="创建一个新项目"></a>创建一个新项目</h2><p>菜单 -&gt; tiny -&gt; file -&gt; new project </p>
<p>创建新的项目 TinyNew</p>
<p>我们可以看到，在 Asset 目录下创建了一个新的名为 TinyNew 的目录</p>
<p>下面有一个 TinyNew.utproject 文件</p>
<p>这个文件就是 tiny mode 的项目文件了</p>
<p>和 Unity 不同，tiny mode 不存在 Scene </p>
<p>双击项目文件，就可以加载项目了</p>
<p>项目的 Inspector 如图</p>


<p>可以选择 Build 类型，需要加载的模块</p>
<p>还有显示设置以及物理设置</p>
<p>从可加载的模块看我们现在基本也可以知道 Tiny Mode 现有的功能有哪些</p>
<p>物理选项只有一个重力，可以看出相比 Unity 本体非常的精简</p>
<p>我们要做的是平面上球触边弹的效果，所以重力设置为 0</p>
<hr>
<h2 id="开始创建主实体"><a href="#开始创建主实体" class="headerlink" title="开始创建主实体"></a>开始创建主实体</h2><p>以前我们的各种玩意，都是放在 GameObject 上的，在 ECS 中，GameObject 没有了，用来放内容的变成了 Entity，所以还是老一套，需要一个 Entity 来放置摄像机什么的</p>
<p>创建一个新的 Entity 现阶段只能从 Tiny 菜单 Create EntityGroup 或者层级图中，点击 Create EntityGroup</p>
<p>我们在 Entities 目录下新建一个 MainGroup，点击后</p>
<p>在 EntityGroup 的 Inspector 中可以看到两个按钮</p>


<ul>
<li>Load: 加载这个组的一个 Entity 实例到层级图中，方便操作</li>
<li>Set as StartUp: 设置为初始 Group，游戏启动时，会自动加载，不能被 Unload</li>
</ul>
<p>我们把 MainGroup 设置为启动加载</p>
<p>在 MainGroup 右边的小菜单里面选择 Camera 新增一个 Camera</p>
<p>再 Create Empty，新建一个空组件，命名为 Spawner，用来产生球球</p>
<p>再 Create Empty，新建一个空组件，命名为 Border，作为边界</p>
<p>导入一个矩形 Sprite, 这里导入 Sprite 的方式和 Unity 本体是一样的，就不多说明了</p>
<p>在 Border 下面 Create 2D Object -&gt; Sprite  </p>
<p>做4个边</p>
<p>给4个边加上 RigidBody2D 和 BoxCollider2D 来做物理效果</p>
<img src="/2018/12/10/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AProjectTiny%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%E5%BC%B9%E7%90%83%E5%92%8C2D%E7%89%A9%E7%90%86/hierarchy.jpg" class="" title="如图">

<p>刚体和碰撞检测的选项都比较简单</p>
<p>说一下刚体的几个 BodyType</p>
<ul>
<li>Static：静态，不做物理模拟，质量无限，不会同其他 static 和 kinematic 做碰撞检测</li>
<li>Kinematic：运动学，质量无限，运动靠 velocity，质量无限，所以不受力的作用，不会同其他 static 和 kinematic 做碰撞检测，移动靠设置他的 Position 或 velocity</li>
<li>Dynamic：动态，全物理模拟，和其他三种类型的刚体做碰撞检测，一般靠给其施加一个力来运动，当然也可以直接设置 velocity 和 Position 但是意义不大</li>
<li>BulletDynamic：子弹动态，和动态差不多，但是使用的连续碰撞检测，更精确，也更消耗资源，好处是不会因为速度过快而穿过其他刚体</li>
</ul>
<p>所以我们的边界选择什么很明显了-&gt; Static</p>
<p>其他几个参数：</p>
<ul>
<li>freezeRotation：如果 true 则不能旋转</li>
<li>friction：摩擦力，0 代表无摩擦，1 代表大摩擦，1 以上代表比 1 大的摩擦（废话）</li>
<li>restitution：弹性系数，0 代表完全吸收，1 代表完全反弹</li>
<li>density：密度，决定刚体的 质量 = 密度 * 体积</li>
</ul>
<p>这里我们选择全反弹 restitution 设置为 1</p>
<h3 id="自定义我们的产生器-spawner"><a href="#自定义我们的产生器-spawner" class="headerlink" title="自定义我们的产生器 spawner"></a>自定义我们的产生器 spawner</h3><p>我们自定义一个组件来产生小球</p>
<p>在 菜单 -&gt; Tiny -&gt; Component </p>
<p>新建一个 Spawner 组件</p>
<p>点击组件，在 inspector 中可以对其字段来做修改</p>
<p>如果 hide_flags 设置为 hide in inspectors 则在层级图中即使添加到实体上了也不会显示出来</p>
<p>add new field 可以添加任意可玩的数值和属性类型</p>
<p>点击属性名称可以修改之，下面可以设置默认值</p>
<p>最后设置如下</p>
<p>我们在延时 1.5s 后每 1.5s 创建一个 spawnedGroup 的实体 最多 maxCount 个</p>
<p>类型右边的 3 个图标分别是</p>
<ul>
<li>是否数组类型</li>
<li>编辑器是否可见：比如我们的 curCount 这个字段编辑器不可见，因为是不用编辑也不能编辑</li>
<li>子菜单 字面上的意思，Document 选项应该和自动生成文档的内容有关</li>
</ul>
<img src="/2018/12/10/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AProjectTiny%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%E5%BC%B9%E7%90%83%E5%92%8C2D%E7%89%A9%E7%90%86/component_inspector.jpg" class="" title="如图">

<p>生成器组件有了，我们继续来搞生成系统</p>
<p>菜单，创建 TypeScript System （后面省略哪里的菜单了哦）</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> game &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** New System */</span></span><br><span class="line">    <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">NewSystem</span> <span class="keyword">extends</span> <span class="title">ut</span>.<span class="title">ComponentSystem</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        OnUpdate():<span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们可以看到生成了一个继承 ut.ComponentSystem 的类，重写一个 OnUpdate 函数</p>
<p>是不是和 Unity ECS 的方式一毛一样</p>
<p>ut 是 unity tiny 的简称</p>
<p>文件名修改为 SpawnSystem</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> game &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">SpawnSystem</span> <span class="keyword">extends</span> <span class="title">ut</span>.<span class="title">ComponentSystem</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        OnUpdate(): <span class="built_in">void</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.world.forEach([game.Spawner], <span class="function">(<span class="params">spawner</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (spawner.isPaused)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> time = spawner.time;</span><br><span class="line">                <span class="keyword">let</span> delay = spawner.delay;</span><br><span class="line"></span><br><span class="line">                time -= ut.Time.deltaTime();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (time &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    time += delay;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;spawn&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (spawner.curCount &lt; spawner.maxCount) &#123;</span><br><span class="line">                        ut.EntityGroup.instantiate(<span class="built_in">this</span>.world, spawner.spawnedGroup);</span><br><span class="line">                        spawner.curCount++</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                spawner.time = time;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码如上，循环 World 中的每一个 Spawner 来操作</p>
<p>至此，生成器组件完成，我们在 MainGroup 的 Spawn 元素的 insepector 中点击 Add Tiny Component 增加一个 Spawner 组件</p>
<p>于是就可以在编辑器中设置这个自定组件的值了</p>
<p>spawnedGroup 设置为 game.BallGroup</p>
<p>maxCount 设置为 10</p>
<hr>
<h2 id="创建球球实体"><a href="#创建球球实体" class="headerlink" title="创建球球实体"></a>创建球球实体</h2><p>创建新的实体组 名为 BallGroup</p>
<p>点击 Load 按钮</p>
<p>放到层级图中</p>
<p>加入一个 2d sprite UnitBall 如图</p>
<p>新建一个新的空组件 BallFlag 用来代表实体是球球</p>
<p>再增加 CircleCollider2D RigidBody2D 组件到球球</p>
<p>调整好圆形检测的半径</p>


<p>做好之后 Unload BallGroup，后面我们都通过 Spawner 来生成球球</p>
<h3 id="球球的行为"><a href="#球球的行为" class="headerlink" title="球球的行为"></a>球球的行为</h3><p>我们需要一个脚本来控制球球生成的地方，并且给一个力让他跑起来</p>
<p>菜单 创建 TypeScript Behavior</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> game &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">NewBehaviourFilter</span> <span class="keyword">extends</span> <span class="title">ut</span>.<span class="title">EntityFilter</span> </span>&#123;</span><br><span class="line">        <span class="attr">node</span>: ut.Core2D.TransformNode;</span><br><span class="line">        position?: ut.Core2D.TransformLocalPosition;</span><br><span class="line">        rotation?: ut.Core2D.TransformLocalRotation;</span><br><span class="line">        scale?: ut.Core2D.TransformLocalScale;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">NewBehaviour</span> <span class="keyword">extends</span> <span class="title">ut</span>.<span class="title">ComponentBehaviour</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="attr">data</span>: NewBehaviourFilter;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ComponentBehaviour lifecycle events</span></span><br><span class="line">        <span class="comment">// uncomment any method you need</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// this method is called for each entity matching the NewBehaviourFilter signature, once when enabled</span></span><br><span class="line">        <span class="comment">//OnEntityEnable():void &#123; &#125;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// this method is called for each entity matching the NewBehaviourFilter signature, every frame it&#x27;s enabled</span></span><br><span class="line">        <span class="comment">//OnEntityUpdate():void &#123; &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// this method is called for each entity matching the NewBehaviourFilter signature, once when disabled</span></span><br><span class="line">        <span class="comment">//OnEntityDisable():void &#123; &#125;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>NewBehaviourFilter 相当于是 Unity ECS 中的 GetEntityGroup 中的 struct</p>
<p>将会获得有这个过滤器下字段的所有 Entity</p>
<p>所以我们需要给 UnitBall 增加一个 空的 BallFlag 来确认他是球球</p>
<ul>
<li>OnEntityEnable. Called only once, the first frame this entity is matched by this behaviour. 获得此Entity的第一帧执行</li>
<li>OnEntityUpdate. Called every frame on matching entities. </li>
<li>OnEntityDisable. Called only once, the first frame this entity is marked as disabled by this behaviour. 设置为 disable 的第一帧执行</li>
</ul>
<p>球球行为代码如下</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> game &#123;</span><br><span class="line">    <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">BallBehaviorFilter</span> <span class="keyword">extends</span> <span class="title">ut</span>.<span class="title">EntityFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="attr">position</span>: ut.Core2D.TransformLocalPosition;</span><br><span class="line">        entity: ut.Entity;</span><br><span class="line">        ball: game.BallFlag;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">BallBehavior</span> <span class="keyword">extends</span> <span class="title">ut</span>.<span class="title">ComponentBehaviour</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="attr">data</span>: BallBehaviorFilter;</span><br><span class="line"></span><br><span class="line">        OnEntityEnable(): <span class="built_in">void</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;ball Enabled&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 随机球球出现的位置</span></span><br><span class="line">            <span class="keyword">let</span> randomX = getRandom(-<span class="number">100</span>, <span class="number">100</span>)</span><br><span class="line">            <span class="keyword">let</span> randomY = getRandom(-<span class="number">100</span>, <span class="number">100</span>)</span><br><span class="line">            <span class="built_in">this</span>.data.position.position = <span class="keyword">new</span> Vector3(randomX, randomY, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 随机给球球一个力，动起来</span></span><br><span class="line">            <span class="comment">// 我们可以看到，这里用了 this.world.addComponentData 给球球添加了一个加力组件，这是一个特殊的组件</span></span><br><span class="line">            <span class="comment">// 这里的 AddImpulse2D 组件会在这一帧之后自动消失掉</span></span><br><span class="line">            <span class="keyword">let</span> impulse = <span class="keyword">new</span> ut.Physics2D.AddImpulse2D;</span><br><span class="line">            <span class="keyword">let</span> newImpulse = <span class="keyword">new</span> Vector2(getRandom(-<span class="number">1</span>, <span class="number">1</span>), getRandom(-<span class="number">1</span>, <span class="number">1</span>)).normalize();</span><br><span class="line">            impulse.impulse = <span class="keyword">new</span> Vector2(newImpulse.x * <span class="number">100</span>, newImpulse.y * <span class="number">100</span>);</span><br><span class="line">            <span class="built_in">this</span>.world.addComponentData(<span class="built_in">this</span>.data.entity, impulse);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;ball created:&quot;</span> + <span class="built_in">this</span>.data.position.position);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        OnEntityUpdate(): <span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getRandom</span>(<span class="params">min, max</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Math</span>.random() * (max - min + <span class="number">1</span>) + min;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>到此我们的工作告一段落，unity 执行后</p>
<p>会在我们的默认浏览器打开一个窗口</p>
<img src="/2018/12/10/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AProjectTiny%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%E5%BC%B9%E7%90%83%E5%92%8C2D%E7%89%A9%E7%90%86/run_game.jpg" class="" title="运行时 Unity 的 Game 窗口">

<p>在浏览器中使用开发者模式可以看到打印</p>
<p>也可以扫描二维码在移动设备上查看效果</p>
<p>运行效果如图</p>
<img src="/2018/12/10/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AProjectTiny%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%E5%BC%B9%E7%90%83%E5%92%8C2D%E7%89%A9%E7%90%86/tiny_run.gif" class="" title="运行">

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://mapz.github.io/2018/12/10/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AProjectTiny%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89%E5%88%9D%E8%AF%86Tiny%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/link-300x300.gif">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="FIND THE CHILD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/10/Unity%E5%AD%A6%E4%B9%A0%EF%BC%9AProjectTiny%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89%E5%88%9D%E8%AF%86Tiny%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">Unity学习：ProjectTiny学习（一）初识Tiny模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-10 11:10:56" itemprop="dateCreated datePublished" datetime="2018-12-10T11:10:56+08:00">2018-12-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-22 10:15:32" itemprop="dateModified" datetime="2021-04-22T10:15:32+08:00">2021-04-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Project-Tiny-是什么？"><a href="#Project-Tiny-是什么？" class="headerlink" title="Project Tiny 是什么？"></a>Project Tiny 是什么？</h2><p>2018年12月，Unity在2018.3beta版本上开放了一个新包的预览下载，叫做ProjectTiny</p>
<p>并发布了一个基于此来制作的网页游戏</p>
<p><a target="_blank" rel="noopener" href="https://blogs.unity3d.com/cn/2018/12/05/project-tiny-preview-package-is-here/">原文Blog传送门</a></p>
<p><a target="_blank" rel="noopener" href="https://tiny-match3.storage.googleapis.com/index.html">Tiny Arms Revenge 游戏体验地址（需科学上网）</a></p>
<p>Project Tiny 的目的，是为更多即开即玩的游戏和互动广告提供支持</p>
<p>现在可以制作2D类型的Web游戏</p>
<p>体验游戏大小仅仅只有 1.8 MB，启动只需下载 969 KB</p>
<hr>
<h2 id="Project-Tiny-现在是什么情况，以后会怎么样？"><a href="#Project-Tiny-现在是什么情况，以后会怎么样？" class="headerlink" title="Project Tiny 现在是什么情况，以后会怎么样？"></a>Project Tiny 现在是什么情况，以后会怎么样？</h2><p>现在正在预览版本，只支持2D游戏，只支持TS语言，将来会支持C#，并移除TS支持，并且不断完善工具链和特性，并支持3D和AR体验</p>
<hr>
<h2 id="Project-Tiny-的特色和亮点？"><a href="#Project-Tiny-的特色和亮点？" class="headerlink" title="Project Tiny 的特色和亮点？"></a>Project Tiny 的特色和亮点？</h2><ul>
<li>纯的ECS模式，或许其编辑器可以看做未来Unity的ECS正式版编辑器的一个预览</li>
<li>ECS模式带来的效率提高</li>
<li>快速制作游戏和互动广告</li>
</ul>
<hr>
<h2 id="我的感觉"><a href="#我的感觉" class="headerlink" title="我的感觉"></a>我的感觉</h2><p>Project Tiny 顾名思义就是一个精干版本的 Unity 啦，用来制作 web 内容，并且其 ECS 模式很可能就是以后的 Unity ECS 模式的预览，学习 Project Tiny 对于我们进一步熟悉 Unity ECS 和提前熟悉新的编辑器都有好处</p>
<hr>
<h2 id="如何开始制作我们的第一个项目？"><a href="#如何开始制作我们的第一个项目？" class="headerlink" title="如何开始制作我们的第一个项目？"></a>如何开始制作我们的第一个项目？</h2><ol>
<li>下载 Unity 2018.3 Beta</li>
<li>打开 Windows -&gt; package manager</li>
<li>点击 Advanced，勾选 show preview packages </li>
<li>下载 Tiny Mode 包</li>
<li>菜单新增项目 Tiny，表示一切 OK</li>
<li>Tiny -&gt; File -&gt; NewProject 新建项目</li>
</ol>
<h2 id="例子项目在哪里？"><a href="#例子项目在哪里？" class="headerlink" title="例子项目在哪里？"></a>例子项目在哪里？</h2><p>菜单 Tiny -&gt; Import Samples 会加载例子到项目中</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mapz"
      src="/images/link-300x300.gif">
  <p class="site-author-name" itemprop="name">Mapz</p>
  <div class="site-description" itemprop="description">FIND THE CHILD</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Mapz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Mapz" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">true</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>















  

  

</body>
</html>
