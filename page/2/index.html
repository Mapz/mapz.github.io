<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/link-300x300.gif?v=5.1.0" />






<meta name="description" content="FIND THE CHILD">
<meta property="og:type" content="website">
<meta property="og:title" content="Mapz&#39;s Blog">
<meta property="og:url" content="http://Mapz.github.io/page/2/index.html">
<meta property="og:site_name" content="Mapz&#39;s Blog">
<meta property="og:description" content="FIND THE CHILD">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mapz&#39;s Blog">
<meta name="twitter:description" content="FIND THE CHILD">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://Mapz.github.io/page/2/"/>





  <title> Mapz's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?69c67c43ced4b46e7ba1656a83e9c872";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mapz's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">可以递归的函数指针</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://Mapz.github.io/2018/12/10/Unity学习：ProjectTiny学习（一）初识Tiny模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/link-300x300.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/12/10/Unity学习：ProjectTiny学习（一）初识Tiny模式/" itemprop="url">
                  Unity学习：ProjectTiny学习（一）初识Tiny模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-10T11:10:56+08:00">
                2018-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/10/Unity学习：ProjectTiny学习（一）初识Tiny模式/" class="leancloud_visitors" data-flag-title="Unity学习：ProjectTiny学习（一）初识Tiny模式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Project-Tiny-是什么？"><a href="#Project-Tiny-是什么？" class="headerlink" title="Project Tiny 是什么？"></a>Project Tiny 是什么？</h2><p>2018年12月，Unity在2018.3beta版本上开放了一个新包的预览下载，叫做ProjectTiny</p>
<p>并发布了一个基于此来制作的网页游戏</p>
<p><a href="https://blogs.unity3d.com/cn/2018/12/05/project-tiny-preview-package-is-here/" target="_blank" rel="noopener">原文Blog传送门</a></p>
<p><a href="https://tiny-match3.storage.googleapis.com/index.html" target="_blank" rel="noopener">Tiny Arms Revenge 游戏体验地址（需科学上网）</a></p>
<p>Project Tiny 的目的，是为更多即开即玩的游戏和互动广告提供支持</p>
<p>现在可以制作2D类型的Web游戏</p>
<p>体验游戏大小仅仅只有 1.8 MB，启动只需下载 969 KB</p>
<hr>
<h2 id="Project-Tiny-现在是什么情况，以后会怎么样？"><a href="#Project-Tiny-现在是什么情况，以后会怎么样？" class="headerlink" title="Project Tiny 现在是什么情况，以后会怎么样？"></a>Project Tiny 现在是什么情况，以后会怎么样？</h2><p>现在正在预览版本，只支持2D游戏，只支持TS语言，将来会支持C#，并移除TS支持，并且不断完善工具链和特性，并支持3D和AR体验</p>
<hr>
<h2 id="Project-Tiny-的特色和亮点？"><a href="#Project-Tiny-的特色和亮点？" class="headerlink" title="Project Tiny 的特色和亮点？"></a>Project Tiny 的特色和亮点？</h2><ul>
<li>纯的ECS模式，或许其编辑器可以看做未来Unity的ECS正式版编辑器的一个预览</li>
<li>ECS模式带来的效率提高</li>
<li>快速制作游戏和互动广告</li>
</ul>
<hr>
<h2 id="我的感觉"><a href="#我的感觉" class="headerlink" title="我的感觉"></a>我的感觉</h2><p>Project Tiny 顾名思义就是一个精干版本的 Unity 啦，用来制作 web 内容，并且其 ECS 模式很可能就是以后的 Unity ECS 模式的预览，学习 Project Tiny 对于我们进一步熟悉 Unity ECS 和提前熟悉新的编辑器都有好处</p>
<hr>
<h2 id="如何开始制作我们的第一个项目？"><a href="#如何开始制作我们的第一个项目？" class="headerlink" title="如何开始制作我们的第一个项目？"></a>如何开始制作我们的第一个项目？</h2><ol>
<li>下载 Unity 2018.3 Beta</li>
<li>打开 Windows -&gt; package manager</li>
<li>点击 Advanced，勾选 show preview packages </li>
<li>下载 Tiny Mode 包</li>
<li>菜单新增项目 Tiny，表示一切 OK</li>
<li>Tiny -&gt; File -&gt; NewProject 新建项目</li>
</ol>
<h2 id="例子项目在哪里？"><a href="#例子项目在哪里？" class="headerlink" title="例子项目在哪里？"></a>例子项目在哪里？</h2><p>菜单 Tiny -&gt; Import Samples 会加载例子到项目中</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://Mapz.github.io/2018/12/03/Unity学习：ECS学习（一）Hybrid模式ECS控制刺蛇移动/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/link-300x300.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/12/03/Unity学习：ECS学习（一）Hybrid模式ECS控制刺蛇移动/" itemprop="url">
                  Unity学习：ECS学习（一）Hybrid模式ECS控制刺蛇移动
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-03T15:53:23+08:00">
                2018-12-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/03/Unity学习：ECS学习（一）Hybrid模式ECS控制刺蛇移动/" class="leancloud_visitors" data-flag-title="Unity学习：ECS学习（一）Hybrid模式ECS控制刺蛇移动">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>Unity 2018 的新功能 ECS 现在已经放出了预览版本，我们现在就来尝试一下</p>
<p>—</p>
<h2 id="Hybrid模式"><a href="#Hybrid模式" class="headerlink" title="Hybrid模式"></a>Hybrid模式</h2><p>hybrid 就是混合模式，因为 Unity ECS 现在还只有预览版本</p>
<p>对 GameObject 和各种 Render 支持很差</p>
<p>所以混合模式可以看成现在的 GameObject 模式到纯 ECS 之间的过渡模式</p>
<p>Hybrid 模式下，并没有在效率上有非常大的提升</p>
<p>比起纯 ECS 模式</p>
<ul>
<li>初始化时间（遍历寻找Entity的过程）无法优化</li>
<li>载入时间无法优化</li>
<li>数据在内存中是随机获取的，非线性，执行效率下降</li>
<li>无法利用多核处理器</li>
<li>没有SIMD</li>
</ul>
<p>但是我们任然可以先尝试通过这种方式，来提高编程效率</p>
<p>并提前熟悉 Unity ECS 的思维模式</p>
<hr>
<h2 id="资源准备"><a href="#资源准备" class="headerlink" title="资源准备"></a>资源准备</h2><p>首先 导入了一组 星际争霸中刺蛇的 Sprite </p>
<p>先在 Sprite Editor 中切好了刺蛇的 走路 Sprite</p>
<p>做好了刺蛇16个方向走路的动作 Animation 和 Animator</p>
<p>Animator 增加参数 Direction Float 控制刺蛇的移动方向</p>
<p>总共 16 方向 做好从 AnyState 到每个方向的 Direction 条件</p>
<img src="/2018/12/03/Unity学习：ECS学习（一）Hybrid模式ECS控制刺蛇移动/unity_01.png" title="做好刺蛇的相关动作">
<p>我们不需要转换动画，所以 每个 translation 的 setting 里面的 duration 都改成 0</p>
<p>并且要把 Can translate to self 取消勾选，不然 永远会卡第一帧</p>
<hr>
<p>我们先通过简单的键盘操作来控制刺蛇移动</p>
<h2 id="设计我们的系统和实体"><a href="#设计我们的系统和实体" class="headerlink" title="设计我们的系统和实体"></a>设计我们的系统和实体</h2><h3 id="实体"><a href="#实体" class="headerlink" title="实体"></a>实体</h3><p>单位实体 Unit 包含的组件</p>
<ul>
<li>位置 Position</li>
<li>速度 Velocity </li>
<li>单位 Unit </li>
<li>输入 PlayerInput</li>
<li>可转向 Directable</li>
</ul>
<h3 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h3><h4 id="逻辑系统"><a href="#逻辑系统" class="headerlink" title="逻辑系统"></a>逻辑系统</h4><p>运动系统-需要</p>
<ul>
<li>位置 Position</li>
<li>速度 Velocity</li>
</ul>
<p>输入系统-需要 的组件</p>
<ul>
<li>输入 PlayerInput </li>
<li>速度 Velocity</li>
</ul>
<h4 id="同步-GameObject-状态的系统"><a href="#同步-GameObject-状态的系统" class="headerlink" title="同步 GameObject 状态的系统"></a>同步 GameObject 状态的系统</h4><p>同步 transform 系统</p>
<ul>
<li>位置 Position</li>
<li>Transform</li>
</ul>
<p>同步刺蛇 Animator 方向状态的系统</p>
<ul>
<li>速度 Velocity （速度控制朝向）</li>
<li>Animator</li>
</ul>
<hr>
<h2 id="编写上述组件和系统的代码"><a href="#编写上述组件和系统的代码" class="headerlink" title="编写上述组件和系统的代码"></a>编写上述组件和系统的代码</h2><h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><h4 id="位置"><a href="#位置" class="headerlink" title="位置"></a>位置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">using Unity.Mathematics;</span><br><span class="line">using UnityEngine;</span><br><span class="line">public class Position2D : MonoBehaviour &#123;</span><br><span class="line">    // 位置 x y</span><br><span class="line">    public float2 Value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="输入"><a href="#输入" class="headerlink" title="输入"></a>输入</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">using Unity.Mathematics;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">public class PlayerInput : MonoBehaviour &#123;</span><br><span class="line">    // 输入 x y</span><br><span class="line">    public float2 Move;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="可转向"><a href="#可转向" class="headerlink" title="可转向"></a>可转向</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">using Unity.Mathematics;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">public class Directable : MonoBehaviour &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="单位"><a href="#单位" class="headerlink" title="单位"></a>单位</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">using Unity.Mathematics;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">public class Unit : MonoBehaviour &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="速度"><a href="#速度" class="headerlink" title="速度"></a>速度</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">using Unity.Mathematics;</span><br><span class="line">using UnityEngine;</span><br><span class="line">public class Velocity : MonoBehaviour &#123;</span><br><span class="line">    // 速度 x y</span><br><span class="line">    public float2 Value;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大家可以看到我们这边都是继承的 MonoBehavior ，有的还是一些空的类</p>
<p>继承 MonoBehavior 才能被添加到 GameObject 中,至于空类的作用我们下面在讲系统的时候来讲</p>
<h3 id="系统-1"><a href="#系统-1" class="headerlink" title="系统"></a>系统</h3><p>ECS 中的 S 意为 System 就是系统了，系统的做法，下面已经比较清楚了</p>
<p>在系统中 可以通过 GetEntities 来自动获得声明好的 结构体数据</p>
<p>结构体数据是从哪里获得的呢？</p>
<p>答案是从游戏中所有的 Entity 来自动获取，由于我们使用的是一个 GameObject ，要获得这个 GameObject 的数据，需要在这个 GameObject 中添加一个内置脚本 GameObjectEntity</p>
<p>表示我们这个 GameObject 是一个 Entity 了</p>
<p>那么大家可能也就知道上面那些空类的作用了</p>
<p>假如我们不对 GameObject 添加 Directable 脚本的话</p>
<p>就无法被 SyncAnimatorDirectionSystem（见下方代码） 中的 GetEntities<data> 来获得</data></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetEntities &lt;T&gt;</span><br></pre></td></tr></table></figure>
<p> 的作用就是获取含有 T 中所有字段类型的 所有 Entity</p>
<p>System 可以使用 UpdateAfter 或者 UpdateBefore 来控制其执行顺序</p>
<h4 id="输入-1"><a href="#输入-1" class="headerlink" title="输入"></a>输入</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">using Unity.Entities;</span><br><span class="line">using Unity.Mathematics;</span><br><span class="line">using UnityEngine;</span><br><span class="line">public class PlayerInputSystem : ComponentSystem &#123;</span><br><span class="line">    struct PlayerData &#123;</span><br><span class="line"></span><br><span class="line">        public PlayerInput Input;</span><br><span class="line">        public Velocity Velocity;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected override void OnUpdate () &#123;</span><br><span class="line">        float dt = Time.deltaTime;</span><br><span class="line"></span><br><span class="line">        foreach (var entity in GetEntities&lt;PlayerData&gt; ()) &#123;</span><br><span class="line">            var pi = entity.Input;</span><br><span class="line"></span><br><span class="line">            pi.Move.x = Input.GetAxis (&quot;Horizontal&quot;);</span><br><span class="line">            pi.Move.y = Input.GetAxis (&quot;Vertical&quot;);</span><br><span class="line"></span><br><span class="line">            entity.Velocity.Value = new float2 (pi.Move.x, pi.Move.y);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="移动"><a href="#移动" class="headerlink" title="移动"></a>移动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">using Unity.Entities;</span><br><span class="line">using Unity.Mathematics;</span><br><span class="line">using UnityEngine;</span><br><span class="line">public class UnitMoveSystem : ComponentSystem &#123;</span><br><span class="line">    struct MoveUnit &#123;</span><br><span class="line"></span><br><span class="line">        public Position2D Position;</span><br><span class="line"></span><br><span class="line">        public Velocity MoveSpeed;</span><br><span class="line"></span><br><span class="line">        public Unit unit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected override void OnUpdate () &#123;</span><br><span class="line">        var dt = Time.deltaTime;</span><br><span class="line">        foreach (var entity in GetEntities&lt;MoveUnit&gt; ()) &#123;</span><br><span class="line">            var pos = entity.Position;</span><br><span class="line">            pos.Value += entity.MoveSpeed.Value * dt;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="同步位置"><a href="#同步位置" class="headerlink" title="同步位置"></a>同步位置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">using Unity.Collections;</span><br><span class="line">using Unity.Entities;</span><br><span class="line">using Unity.Mathematics;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">[UpdateAfter (typeof (UnitMoveSystem))]</span><br><span class="line">public class SyncTransformSystem : ComponentSystem &#123;</span><br><span class="line">    public struct Data &#123;</span><br><span class="line"></span><br><span class="line">        [ReadOnly] public Position2D Position;</span><br><span class="line"></span><br><span class="line">        public Transform Output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected override void OnUpdate () &#123;</span><br><span class="line">        foreach (var entity in GetEntities&lt;Data&gt; ()) &#123;</span><br><span class="line">            float2 p = entity.Position.Value;</span><br><span class="line">            entity.Output.position = new float3 (p.x, p.y, 0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<h4 id="同步动画朝向状态"><a href="#同步动画朝向状态" class="headerlink" title="同步动画朝向状态"></a>同步动画朝向状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">using Unity.Collections;</span><br><span class="line">using Unity.Entities;</span><br><span class="line">using Unity.Mathematics;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">[UpdateAfter (typeof (PlayerInputSystem))]</span><br><span class="line">public class SyncAnimatorDirectionSystem : ComponentSystem &#123;</span><br><span class="line"></span><br><span class="line">    public struct Data &#123;</span><br><span class="line"></span><br><span class="line">        [ReadOnly] public Velocity moveSpeed;</span><br><span class="line"></span><br><span class="line">        public Animator Output;</span><br><span class="line"></span><br><span class="line">        public Directable directable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected override void OnUpdate () &#123;</span><br><span class="line">        foreach (var entity in GetEntities&lt;Data&gt; ()) &#123;</span><br><span class="line"></span><br><span class="line">            float2 p = entity.moveSpeed.Value;</span><br><span class="line"></span><br><span class="line">            var angle = Mathf.Atan2 (p.x, p.y) * Mathf.Rad2Deg;</span><br><span class="line">            if (angle &lt; 0) &#123;</span><br><span class="line">                angle = 360 + angle;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            entity.Output.SetFloat (&quot;Direction&quot;, angle);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 刺蛇的 Prefab 下添加需要的组件脚本</p>
<p>如下图</p>

<p>加载刺蛇预制体,这里使用 Lua 加载的</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> go = UnityEngine.GameObject.Instantiate(prefab)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>按 wasd 来操作刺蛇移动</p>
<img src="/2018/12/03/Unity学习：ECS学习（一）Hybrid模式ECS控制刺蛇移动/unity_03.gif" title="刺蛇可以移动了">

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://Mapz.github.io/2018/12/03/Unity学习：切割Sprite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/link-300x300.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/12/03/Unity学习：切割Sprite/" itemprop="url">
                  Unity学习：切割Sprite
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-03T11:22:55+08:00">
                2018-12-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/03/Unity学习：切割Sprite/" class="leancloud_visitors" data-flag-title="Unity学习：切割Sprite">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>很多2D老资源是打好成一张图的，我们需要去切成一个一个的sprite</p>
<p>这时候导入图片后，材质类型选择 Sprite and UI ， Sprite 类型选择 Mutiple</p>
<p>然后打开 Sprite Editor，自己切就可以了</p>
<p>Sprite Editor 里面选择 Slice 切片</p>
<p>如果图片中有框，选择 自动切应该就 OK</p>
<p>否则还有按 大小切 和 按个数来切</p>
<p>切完之后 点击每个片片，可以手动再修改一下</p>
<hr>
<h2 id="使用脚本来处理每个切片"><a href="#使用脚本来处理每个切片" class="headerlink" title="使用脚本来处理每个切片"></a>使用脚本来处理每个切片</h2><p>我们导入的素材每个sprite有个小黑框，这个小黑框我们不要，怎么办呢？</p>
<p>每个手动去重新校正太麻烦，自己写个Editor脚本来解决吧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEditor;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">public class SpriteCustomScrips : MonoBehaviour &#123;</span><br><span class="line"></span><br><span class="line">	[MenuItem (&quot;Sprites/Rect small by 1&quot;)]</span><br><span class="line">	static void SpritesSmallBy1 () &#123;</span><br><span class="line">		// Debug.Log (Selection.</span><br><span class="line"></span><br><span class="line">		string path = AssetDatabase.GetAssetPath (Selection.activeObject);</span><br><span class="line">		Debug.Log (path);</span><br><span class="line"></span><br><span class="line">		TextureImporter ti = AssetImporter.GetAtPath (path) as TextureImporter;</span><br><span class="line">		SpriteMetaData[] spriteSheet = ti.spritesheet;</span><br><span class="line">		for (int i = 0; i &lt; spriteSheet.Length; i++) &#123;</span><br><span class="line"></span><br><span class="line">			if (spriteSheet[i].name.StartsWith (&quot;Hydra_walk_&quot;)) &#123;</span><br><span class="line">				spriteSheet[i].rect = new Rect (spriteSheet[i].rect.x + 1, spriteSheet[i].rect.y + 1, spriteSheet[i].rect.width - 2, spriteSheet[i].rect.height - 2);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		ti.spritesheet = spriteSheet;</span><br><span class="line">		EditorUtility.SetDirty (ti);</span><br><span class="line">		ti.SaveAndReimport ();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的脚本大家可以参考一下，修改了一下sprite的rect</p>
<p>然后我们在project视图中选中刚才自动切好的资源，点击菜单处理一下，发现1px的小黑框没有了</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://Mapz.github.io/2018/11/30/Unity学习：UGUI按钮的导航属性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/link-300x300.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/11/30/Unity学习：UGUI按钮的导航属性/" itemprop="url">
                  Unity学习：UGUI按钮的导航属性
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-30T11:16:35+08:00">
                2018-11-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/11/30/Unity学习：UGUI按钮的导航属性/" class="leancloud_visitors" data-flag-title="Unity学习：UGUI按钮的导航属性">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>UGUI 中的按钮有4个状态，包括 Normal highlighted pressed disabled</p>
<p>而导航属性可以决定这几个状态之间的切换</p>
<p>如果选中了导航属性，则按钮在点击后，会进入选中状态，表现为highlighted, 鼠标移出，也不会回复normal状态</p>
<p>类似于老式录音机的 按下 或者说 单选组 状态，需要按其他的按钮才能回到 normal 状态</p>
<p>所以我们搞单个按钮的时候 应当把按钮的导航关闭</p>
<hr>
<p>导航的另外一个功能，就是UI按钮的切换高光顺序</p>
<p>类似于我们在UI上按 tab 按键 切换选中的元素一样</p>
<p>至于导航的几个选项，就是字面上的意思啦</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://Mapz.github.io/2018/01/31/使用Node搭建静态文件服务器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/link-300x300.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/31/使用Node搭建静态文件服务器/" itemprop="url">
                  使用Node搭建静态文件服务器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-31T12:22:55+08:00">
                2018-01-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/01/31/使用Node搭建静态文件服务器/" class="leancloud_visitors" data-flag-title="使用Node搭建静态文件服务器">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>Mac 更新系统后原来机器上的 apache 配置丢失，我又不想去重新配置 apache 的虚拟目录和虚拟服务器</p>
<p>对付下测试环境的文件资源服务器，用 Node 还是挺方便的，那么步骤如下</p>
<hr>
<p><strong>需求 : Node 环境已经装好</strong></p>
<p>作为一个资深API调试员，使用开源库</p>
<p><a href="https://github.com/cloudhead/node-static" target="_blank" rel="noopener">https://github.com/cloudhead/node-static</a></p>
<p>使用命令行安装之</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g node-static</span><br></pre></td></tr></table></figure>
<p>然后编写 Node 脚本</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> port = <span class="number">8080</span>;</span><br><span class="line"><span class="keyword">var</span> doc_root = <span class="string">"/server_root"</span> <span class="comment">//文件服根目录</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">'node-static'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fileServer = <span class="keyword">new</span> <span class="keyword">static</span>.Server(doc_root);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'http'</span>).createServer(<span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">    request.addListener(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        fileServer.serve(request, response);</span><br><span class="line">    &#125;).resume();</span><br><span class="line">&#125;).listen(<span class="number">8080</span>);</span><br></pre></td></tr></table></figure>
<p>启动 Node 脚本</p>
<h1 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h1>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://Mapz.github.io/2018/01/17/导出字体文件文本为PNG/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/link-300x300.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/17/导出字体文件文本为PNG/" itemprop="url">
                  导出字体文件文本为PNG
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-17T16:19:04+08:00">
                2018-01-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/01/17/导出字体文件文本为PNG/" class="leancloud_visitors" data-flag-title="导出字体文件文本为PNG">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>有时候我们需要从字体文件中直接提取文字并导出成PNG格式</p>
<p>经过Google后找到可以用 ImageMagick 来搞</p>
<p>以下方式都在 Mac 下测试通过，Windows也可以，但安装方式稍有不同</p>
<hr>
<h2 id="下载-MacPorts"><a href="#下载-MacPorts" class="headerlink" title="下载 MacPorts"></a>下载 MacPorts</h2><p>应该是和 homebrew 类似的一个安装工具</p>
<p>安好后经可以使用命令行来获取 ImageMagick</p>
<p><a href="https://www.macports.org/install.php" target="_blank" rel="noopener">点我去下载</a></p>
<p>注意看自己的 macOS 版本</p>
<h2 id="安装-ImageMagick"><a href="#安装-ImageMagick" class="headerlink" title="安装 ImageMagick"></a>安装 ImageMagick</h2><p>安好 MacPorts 后</p>
<p>命令行获取即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo port install ImageMagick</span><br></pre></td></tr></table></figure>
<p>也可以用源码直接安装，参考 <a href="http://www.imagemagick.org/script/download.php" target="_blank" rel="noopener">这里</a></p>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">convert -background none -fill black -font 方正像素12.TTF -pointsize 300 label:<span class="string">"主"</span> 主.png</span><br></pre></td></tr></table></figure>
<hr>
<p>详情参考</p>
<p><a href="http://www.imagemagick.org/script/download.php" target="_blank" rel="noopener">这里</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://Mapz.github.io/2017/05/12/Django项目开发（四）Vue2 ElementUI页面制作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/link-300x300.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/12/Django项目开发（四）Vue2 ElementUI页面制作/" itemprop="url">
                  Django项目开发（四）Vue2 ElementUI页面制作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-12T10:22:19+08:00">
                2017-05-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/12/Django项目开发（四）Vue2 ElementUI页面制作/" class="leancloud_visitors" data-flag-title="Django项目开发（四）Vue2 ElementUI页面制作">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>原文地址：<a href="">Mapz的blog</a></p>
<p>前文目录：</p>
<ol>
<li><a href="https://mapz.github.io/2017/05/08/Django%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%90%AD%E5%BB%BA/">Django项目的搭建</a></li>
<li><a href="https://mapz.github.io/2017/05/08/Django%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80%EF%BC%89/">Django项目开发（一）</a></li>
<li><a href="https://mapz.github.io/2017/05/10/Django%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89View%E5%B1%82/">Django项目开发（二）View层</a></li>
<li><a href="https://mapz.github.io/2017/05/10/Django%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%89%EF%BC%89%E7%BB%93%E5%90%88Vue/">Django项目开发（三）结合Vue</a></li>
</ol>
<p>前文讲了我们怎么把vue和django结合起来，这次我们讲讲vue的基本开发</p>
<h2 id="初见Vue"><a href="#初见Vue" class="headerlink" title="初见Vue"></a>初见Vue</h2><h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><p>假设我们已经知道了css html 和 JavaScript 基础，那 Vue 对你来说肯定不是难事，他的简单易用性可以快速上手</p>
<p>我们查看我们之前生成的单页应用的src目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── App.vue <span class="comment"># 入口vue组件</span></span><br><span class="line">├── assets <span class="comment"># 资源目录</span></span><br><span class="line">│   └── logo.png </span><br><span class="line">├── components <span class="comment"># 组件目录</span></span><br><span class="line">│   └── Hello.vue <span class="comment"># 组件</span></span><br><span class="line">├── main.js <span class="comment"># 启动代码</span></span><br><span class="line">└── router <span class="comment"># 路由</span></span><br><span class="line">    └── index.js</span><br></pre></td></tr></table></figure>
<p>.vue 文件是 vue 的基本组成形式，一个文件代表一个组件</p>
<p>其中 template 区域表示本组件的模版， script 区是代码区 type 标签里面则是样式声明</p>
<p>type 可以使用多种样式表语言 css less 什么的都可以（需要安装相关支持）</p>
<p>我们再看App.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">    &lt;img src=<span class="string">"./assets/logo.png"</span>&gt;</span><br><span class="line">    &lt;router-view&gt;<span class="xml"><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">export default &#123;</span></span><br><span class="line"><span class="regexp">  name: 'app'</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">#app &#123;</span><br><span class="line">  font-family: <span class="string">'Avenir'</span>, Helvetica, Arial, sans-serif;</span><br><span class="line">  -webkit-font-smoothing: antialiased;</span><br><span class="line">  -moz-osx-font-smoothing: grayscale;</span><br><span class="line">  text-align: center;</span><br><span class="line">  color: #2c3e50;</span><br><span class="line">  margin-top: <span class="number">60</span>px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/style&gt;</span></span><br></pre></td></tr></table></figure>
<p>那么这个组件是怎么变成入口的呢</p>
<p>可以看外面的index.html</p>
<p>中间有个 id=app 的div</p>
<p>在 main.js 中有这么一段</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  router,</span><br><span class="line">  template: <span class="string">'&lt;App/&gt;'</span>,</span><br><span class="line">  components: &#123; App &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这里的 el 就是这个 vue 实例要挂载的元素<br>template 是用来挂在的模版<br>components 是用来挂在的内容，也就是我们的 App.vue</p>
<p>这样App.vue的内容就自动注入到index.html中了</p>
<h3 id="数据绑定"><a href="#数据绑定" class="headerlink" title="数据绑定"></a>数据绑定</h3><p>前面我们讲了，Vue 的特点之一是数据双向绑定，也就是说展示的内容和模型的内容是绑定的，同步的，修改一个，另一个就会一起变化，Vue在实现这个功能的时候，为了将所有数据都收归 Vue 来管理，所以数据的声明必须由 Vue 来操作</p>
<p>我们移步hello.vue</p>
<p>在代码块中有个 data() 函数，这个函数里面就是声明我们的数据区，在这里面声明的内容，Vue会自动给他加上 getter和setter，这个过程对使用者来说事透明的，你不会注意到她，当一个数据读取或者变化的时候，就会调用setter和getter，从而触发 Vue 对绑定这个数据的内容的刷新，所以我们的数据块，都在 data() 区声明，是很重要的</p>
<p>另外，data() 返回的不是一个数据实例，而是一个返回数据副本的函数，这个很重要</p>
<p>为什么呢，因为我们知道 Vue 的组件是可以复用的，所以每次都要返回单独的数据实例呀，否则不是成了相当于 Java 中 static 数据的东西了吗</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;h1&gt;&#123;&#123; msg &#125;&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">data () &#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">        msg: 'Welcome to Your Vue.js App'</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>我们看到，我们声明的数据，在写模版的时候用双层引号来渲染</p>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p>我们的App.vue是怎么显示出hello.vue组件的内容的呢</p>
<p>我们看到 app 的模版中 有个 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个标签会自动渲染路由的内容</p>
<p>在 main.js 中我们引入了路由<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br></pre></td></tr></table></figure></p>
<p>在router的index.js中我们看到<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'vue-router'</span></span><br><span class="line"><span class="keyword">import</span> Hello <span class="keyword">from</span> <span class="string">'@/components/Hello'</span></span><br><span class="line"></span><br><span class="line">Vue.use(Router)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Router(&#123;</span><br><span class="line">  routes: [</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">'/'</span>, <span class="comment">//配置访问路径</span></span><br><span class="line">      name: <span class="string">'Hello'</span>, <span class="comment">//配置路径“页面”名称</span></span><br><span class="line">      component: Hello <span class="comment">//配置要渲染的组件</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>使用了vue-router工具来做路由</p>
<p>导出了一个路由配置</p>
<p>所以我们在访问路径/的时候，Hello.vue就渲染在了 router-view 上</p>
<hr>
<h2 id="安装vue-admin"><a href="#安装vue-admin" class="headerlink" title="安装vue-admin"></a>安装vue-admin</h2><p><a href="http://element.eleme.io/#/zh-CN/component/quickstart" target="_blank" rel="noopener">ElementUI文档</a></p>
<p>ElementUI是饿了吗弄的一个模版，适合来做管理工具的前端</p>
<p>我们这里就直接使用一个基于elementui的开源模版vue-admin来开发</p>
<p>开发的时候又问题随时参考文档</p>
<p><a href="https://github.com/taylorchen709/vue-admin" target="_blank" rel="noopener">vue-admin</a></p>
<p>下载下来</p>
<p>删掉 frontend 目录里面的所有内容，然后把下载下来的 vue-admin 内容解压 copy 进去</p>
<p>然后在 frontend 中执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<p>因为里面有安装node-sass</p>
<p>如果安装出错了，可以先安装这个东西(支持一种css加强语法的工具)，加上镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SASS_BINARY_SITE=https://npm.taobao.org/mirrors/node-sass/ npm install node-sass</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm build</span><br></pre></td></tr></table></figure>
<p>我们还需要修改webpack中的一个参数让导出的静态调用地址适配 django中 的设置<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br></pre></td></tr></table></figure></p>
<p>打开 vue 项目中的webpack.config.js文件</p>
<p>修改为<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">assetsRoot: path.resolve(__dirname, <span class="string">'../dist/static'</span>),</span><br><span class="line">assetsSubDirectory: <span class="string">''</span>,</span><br><span class="line">assetsPublicPath: <span class="string">'/static/'</span>,</span><br></pre></td></tr></table></figure></p>
<p>这样webpack导出的内容中的static的东西，都会以/static/的url前缀去调用，和django中一样了</p>
<p>访问 django 的站点 <a href="http://127.0.0.1:8000/qk_deploy/" target="_blank" rel="noopener">http://127.0.0.1:8000/qk_deploy/</a></p>
<p>和 vue 的测试站点 <a href="http://127.0.0.1:8010/" target="_blank" rel="noopener">http://127.0.0.1:8010/</a></p>
<p>现在都可以正确访问我们的内容了</p>
<p>但是为了不每次访问的时候都打包，所以一般我们用 vue 的测试站点来进行测试</p>
<hr>
<h2 id="对接API：登陆"><a href="#对接API：登陆" class="headerlink" title="对接API：登陆"></a>对接API：登陆</h2><p>我们可以看到 vue-admin 里面使用的是 axios 作为 Ajax 库</p>
<p>作为示范，作者使用 mock 来制作了假数据</p>
<p>我们屏蔽掉 mock 开始接入我们写好的 django 登陆 api</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改 main.js 屏蔽mock</span></span><br><span class="line"><span class="comment">// import Mock from './mock'</span></span><br><span class="line"><span class="comment">// Mock.bootstrap();</span></span><br></pre></td></tr></table></figure>
<p>修改 api.js,设置为我们的接口地址<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// let base = '';</span></span><br><span class="line"><span class="keyword">let</span> base = <span class="string">'http://127.0.0.1:8000/qk_deploy/api'</span></span><br></pre></td></tr></table></figure></p>
<p>访问 <a href="http://127.0.0.1:8080/#/login" target="_blank" rel="noopener">http://127.0.0.1:8080/#/login</a></p>
<p>测试登陆</p>
<p>我们已经可以请求登陆啦~~</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://Mapz.github.io/2017/05/10/Django项目开发（三）结合Vue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/link-300x300.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/10/Django项目开发（三）结合Vue/" itemprop="url">
                  Django项目开发（三）结合Vue
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-10T17:20:49+08:00">
                2017-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/10/Django项目开发（三）结合Vue/" class="leancloud_visitors" data-flag-title="Django项目开发（三）结合Vue">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>原文地址：<a href="https://mapz.github.io/2017/05/10/Django%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%89%EF%BC%89%E7%BB%93%E5%90%88Vue/">Mapz的blog</a></p>
<p>前文目录：</p>
<ol>
<li><a href="https://mapz.github.io/2017/05/08/Django%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%90%AD%E5%BB%BA/">Django项目的搭建</a></li>
<li><a href="https://mapz.github.io/2017/05/08/Django%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80%EF%BC%89/">Django项目开发（一）</a></li>
<li><a href="https://mapz.github.io/2017/05/10/Django%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89View%E5%B1%82/">Django项目开发（二）View层</a></li>
</ol>
<p>前面我们介绍了Django的一些基本安装和使用</p>
<p>因为我们项目将会使用前后端分离的技术来处理，所以我们将会放弃使用Django的View层来处理业务逻辑，而只是用Django做ORM和API接口，并使用 Vue.js 2 来制作前端页面</p>
<hr>
<h2 id="Vue-js-简介"><a href="#Vue-js-简介" class="headerlink" title="Vue.js 简介"></a>Vue.js 简介</h2><h3 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h3><p>Vue 采用 MVVM 的模式，MVVM 是 MVC 的衍生物</p>
<p>他和 MVC 的区别在哪儿呢</p>
<p>在 MVVM 中 C 变成了 VM</p>
<p>在 MVC 中用户可以直接操作 C 层 或是通过 V 层来操作 Model</p>
<p>C 层一般只有路由的作用 而 V 层则承载了大量的业务逻辑，非常臃肿</p>
<p>而在 MVVM 中 View 和 Model 之间不再直接发生关系了</p>
<p>View 层也不在有任何业务逻辑，他是真的只作为展示层来使用</p>
<p>逻辑去了哪儿呢？答案是 VM 层，就是 ModelView</p>
<p>然后为什么说 MVVM 可以方便的实现数据和逻辑分离呢</p>
<p>关键在 VM 层和 M 层是双向绑定的</p>
<p>也就是说，我在 VM 层经过逻辑处理的数据，会自动表现在 View 层上，也会自动改变 Model 层中的数据</p>
<p>于是我们的数据、逻辑和渲染，就完全分开了</p>
<p>简而言之：</p>
<p><strong>我只需要修改好我的业务逻辑，配置好数据，写好模版，所有的一切就可以自动呈现和更新了</strong> </p>
<p>业务逻辑，数据和展示真正做到了分离</p>
<h3 id="Vue-js"><a href="#Vue-js" class="headerlink" title="Vue.js"></a>Vue.js</h3><p>Vue React Angular 都是最近比较流行的前端框架</p>
<p>数据的双向绑定，响应式和组件化 都是他们的思维要点</p>
<p>Vue 相比另两个，优点是学习成本低，性能高，并且虽然比不上另外两个，但任然有着比较丰富的生态</p>
<p>另外 Vue 还有他的原生兄弟 Weex</p>
<p>Weex 是阿里的跨平台用户界面开发框架，他兼容 Vue 的语法</p>
<p>也就是说 </p>
<p><strong>学会 Vue 之后，你也可以让你的代码跑上 iOS 和 Android</strong></p>
<p>当然啦，React 也有对应的 ReactNative 来做原生应用</p>
<hr>
<h2 id="集成-Vue-到-Django-中"><a href="#集成-Vue-到-Django-中" class="headerlink" title="集成 Vue 到 Django 中"></a>集成 Vue 到 Django 中</h2><p>我们假定你的机器上已经装好了</p>
<ul>
<li>Node.js 4+</li>
<li>npm 3+</li>
<li>Python 2.7+</li>
</ul>
<p>以下安装需要基于上述环境</p>
<h3 id="安装-vue-cli"><a href="#安装-vue-cli" class="headerlink" title="安装 vue-cli"></a>安装 vue-cli</h3><p>vue 一般使用 vue-cli 来初始化我们的项目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i vue-cli -g --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<p>-g 的意思是全局安装</p>
<p>–registry 参数是镜像，我们在国内一般用淘宝的镜像比较快</p>
<h3 id="创建-vue-项目"><a href="#创建-vue-项目" class="headerlink" title="创建 vue 项目"></a>创建 vue 项目</h3><p>回到我们的django项目的目录下，用vue-cli 创建一个项目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue-init webpack frontend</span><br></pre></td></tr></table></figure>
<p>其中 frontend 是我们的 vue 工程目录名称</p>
<p>中间的参数是我们要用到的模版</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure>
<p>这个命令可以导出webpack输出，简单说就是web工程打包</p>
<p>build 好的内容导出 dist 目录下，也就是我们django中要用到的内容了</p>
<h3 id="Django下的配置"><a href="#Django下的配置" class="headerlink" title="Django下的配置"></a>Django下的配置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># settings.py 需要加载模版，所以要修改我们的模版目录加上dist目录</span></span><br><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">'DIRS'</span>: [<span class="string">'frontend/dist/'</span>],</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 让Django能去dist下寻找静态文件</span></span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">"frontend/dist/static"</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># qk_deploy/urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> TemplateView</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将我们的文件直接作为模版引入</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^$'</span>, TemplateView.as_view(template_name=<span class="string">"index.html"</span>))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>我们现在访问</p>
<p><a href="http://127.0.0.1:8000/qk_deploy/#/" target="_blank" rel="noopener">http://127.0.0.1:8000/qk_deploy/#/</a></p>
<p>应该可以看到 vue 的欢迎页面了</p>
<h3 id="搭建调试环境"><a href="#搭建调试环境" class="headerlink" title="搭建调试环境"></a>搭建调试环境</h3><p>如果我们使用 Django的环境来进行测试呢，也就会导致，每次修改了vue项目的文件都要重新build，这样太慢了</p>
<p>vue.js的开发环境会自动检查文件变化来重新构建，是比较方便的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure>
<p>会启动vue的开发环境，但这样有个问题，使用vue的开发环境，就是脱离了Django的开发环境了，访问Django上的API出现了跨域问题</p>
<p>为了能让我们快乐的调试呢，我们使用Django的第三方插件django-cors-headers来解决跨域问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-cors-headers</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">MIDDLEWARE_CLASSES = [</span><br><span class="line">    <span class="string">'django.middleware.security.SecurityMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</span><br><span class="line">    <span class="string">'corsheaders.middleware.CorsMiddleware'</span>, <span class="comment">#注意顺序不能变</span></span><br><span class="line">    <span class="string">'django.middleware.common.CommonMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.csrf.CsrfViewMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.auth.middleware.SessionAuthenticationMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages.middleware.MessageMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">CORS_ORIGIN_ALLOW_ALL = <span class="keyword">True</span> <span class="comment">#添加这个配置</span></span><br></pre></td></tr></table></figure>
<h3 id="Django-配置-RESTful-API"><a href="#Django-配置-RESTful-API" class="headerlink" title="Django 配置 RESTful API"></a>Django 配置 RESTful API</h3><p>不用Django的后端渲染了，我们使用RESTful API作为前后端交流的工具</p>
<h4 id="安装-djangorestframework"><a href="#安装-djangorestframework" class="headerlink" title="安装 djangorestframework "></a>安装 djangorestframework </h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com</span><br><span class="line">pip install markdown -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com</span><br><span class="line">pip install django-filter -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com</span><br></pre></td></tr></table></figure>
<p>这里我们和 npm 安装东西的时候一样，使用了镜像，不然下载的太慢了啦 pip 使用镜像用-i参数<br>对于不是https的地址，必须用 –trusted-host 才能继续</p>
<p>装好后</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'rest_framework'</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目根目录下 url.py</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r'^api-auth/'</span>, include(<span class="string">'rest_framework.urls'</span>, namespace=<span class="string">'rest_framework'</span>))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="创建model和serializer"><a href="#创建model和serializer" class="headerlink" title="创建model和serializer"></a>创建model和serializer</h4><p>我们这里将用用户登陆为例，来看怎么写和使用API</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions,status</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BasicAuthentication</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserLogin</span><span class="params">(generics.CreateAPIView)</span>:</span></span><br><span class="line">    permission_classes = (permissions.AllowAny,)</span><br><span class="line">    serializer_class = LoginSerializer</span><br><span class="line">    authentication_classes = (BasicAuthentication,) <span class="comment">#这里一定要是 BasicAuthentication，否则会出现CSRF问题，因为我们现在是登陆，登录前么有在session中用CSRF，这个问题我们后面来说</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            username = request.data.get(<span class="string">'username'</span>)</span><br><span class="line">            print(username)</span><br><span class="line">            password = request.data.get(<span class="string">'password'</span>)</span><br><span class="line">            print(password)</span><br><span class="line">            user = User.objects.get(username__iexact=username)</span><br><span class="line">            print(user)</span><br><span class="line">            <span class="keyword">if</span> user.check_password(password):</span><br><span class="line">                serializer = LoginSerializer(&#123;<span class="string">'id'</span>: user.id, <span class="string">'username'</span>: user.username&#125;)</span><br><span class="line">                <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">            <span class="keyword">return</span> Response(status=status.HTTP_401_UNAUTHORIZED)</span><br><span class="line">        <span class="keyword">except</span> User.DoesNotExist:</span><br><span class="line">            <span class="keyword">return</span> Response(status=status.HTTP_401_UNAUTHORIZED)</span><br></pre></td></tr></table></figure>
<p>创建我们的登陆view<br><br>创建serializers.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line"></span><br><span class="line">    username = serializers.CharField(required=<span class="keyword">False</span>, max_length=<span class="number">1024</span>)</span><br><span class="line">    password = serializers.CharField(required=<span class="keyword">False</span>, max_length=<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">'id'</span>, <span class="string">'username'</span>, <span class="string">'password'</span>)</span><br></pre></td></tr></table></figure>
<p>urls.py中加上<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r'^api/login$'</span>, UserLogin.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>访问</p>
<p><a href="http://127.0.0.1:8000/qk_deploy/api/login" target="_blank" rel="noopener">http://127.0.0.1:8000/qk_deploy/api/login</a></p>
<p>可以看到 restful_framework的测试界面</p>
<p>在界面测试API</p>
<p>用已有的用户登陆，已经可以看到正确的回应了，否则会返回状态401</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://Mapz.github.io/2017/05/10/Django项目开发（二）View层/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/link-300x300.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/10/Django项目开发（二）View层/" itemprop="url">
                  Django项目开发（二）View层
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-10T10:55:48+08:00">
                2017-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/10/Django项目开发（二）View层/" class="leancloud_visitors" data-flag-title="Django项目开发（二）View层">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>原文地址：<a href="https://mapz.github.io/2017/05/10/Django%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89View%E5%B1%82/">Mapz的blog</a></p>
<p>前文目录：</p>
<ol>
<li><a href="https://mapz.github.io/2017/05/08/Django%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%90%AD%E5%BB%BA/">Django项目的搭建</a></li>
<li><a href="https://mapz.github.io/2017/05/08/Django%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80%EF%BC%89/">Django项目开发（一）</a></li>
</ol>
<p>前面我们已经创建好了我们的数据库表，也可以管理我们的数据内容了，下面就应该是如何来展示我们的网站内容</p>
<h2 id="基本方式"><a href="#基本方式" class="headerlink" title="基本方式"></a>基本方式</h2><p>前面大家看例子的时候已经看到了，我们在 views.py 中，写一个函数，返回一个HttpRespnse对象，参数为字符串hello world，并在 urls.py 里面配置好他的路由，就可以通过浏览器来访问我们的页面了，没错，这就是一个最简单的view，返回一个HttpRespnse对象，只包含一段字符串到浏览器。</p>
<hr>
<h2 id="Url路由"><a href="#Url路由" class="headerlink" title="Url路由"></a>Url路由</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^$'</span>, views.index, name=<span class="string">'index'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>每增加一个路由，我们都在urlpatterns里面增加一个url()函数生成的对象</p>
<p>我们可以看看这个函数原型<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">url</span><span class="params">(regex, view, kwargs=None, name=None, prefix=<span class="string">''</span>)</span></span></span><br></pre></td></tr></table></figure></p>
<ol>
<li>第一个参数为浏览器访问的url路由正则表达式</li>
<li>第二个参数是处理这个请求的view</li>
<li>第三个参数是显式的传入参数</li>
<li>第四个参数是这个url的名称，常用于渲染模版的时候，避免改需求后模版上url写死了要到处修改用（写模版的时候不要写死跳转的url，而是用name来渲染是一个良好的习惯），另外，后面我们会知道，一个视图view经常对应很多pattern，用name也可在使用的时候加以区分</li>
<li>prefix 在view上加上前缀，一般不会用到这个</li>
</ol>
<p>正则表达式中用小括号括起来的内容，会作为参数传入到view中的处理函数中</p>
<p>为了测试路由中各种用法，我们创建一个文件专门放我们的测试view</p>
<h3 id="隐式的传参"><a href="#隐式的传参" class="headerlink" title="隐式的传参"></a>隐式的传参</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test_views.py</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(request,p1,p2)</span>:</span></span><br><span class="line">    p1 = float(p1)</span><br><span class="line">    p2 = float(p2)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"%f + %f = %f"</span> % (p1,p2,p1+p2))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views,test_views</span><br><span class="line">testPatterns = [</span><br><span class="line">    url(<span class="string">r'^add(\d+)and(\d+)/$'</span>, test_views.add, name=<span class="string">'add'</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns.extend(testPatterns)</span><br></pre></td></tr></table></figure>
<p>我们看url中有两个参数</p>
<p>当我们访问 <a href="http://127.0.0.1:8000/qk_deploy/add1and2/" target="_blank" rel="noopener">http://127.0.0.1:8000/qk_deploy/add1and2/</a> 的时候，他们被顺序的传入test_view.add函数的p1和p2</p>
<p>需要注意的是，通过正则穿进去的参数，都是字符串形式的，要转型需要我们在代码中处理</p>
<p>最后我们在浏览器中得到了返回</p>
<blockquote>
<p>1.000000 + 2.000000 = 3.000000</p>
</blockquote>
<h3 id="显式的传参"><a href="#显式的传参" class="headerlink" title="显式的传参"></a>显式的传参</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test_views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">southparkB</span><span class="params">(request,stan_power,cartman_power)</span>:</span></span><br><span class="line">    stan_power = float(stan_power)</span><br><span class="line">    cartman_power = float(cartman_power)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'Stan win'</span> <span class="keyword">if</span> stan_power &gt; cartman_power <span class="keyword">else</span> <span class="string">'Cartman win'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">testPatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r'^southpark-b/stan(?P&lt;stan_power&gt;\d+)/cartman(?P&lt;cartman_power&gt;\d+)/$'</span>, test_views.southparkB,name=<span class="string">'southparkB'</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns.extend(testPatterns)</span><br></pre></td></tr></table></figure>
<p>用括号括起来的部分依然是参数，但是我们用<strong>?P&lt;参数名&gt;</strong>来传递参数<br>然后在 test_view.southparkB 中，用相同的参数名来取出</p>
<p>访问</p>
<p><a href="http://127.0.0.1:8000/qk_deploy/southpark-b/stan19/cartman10/" target="_blank" rel="noopener">http://127.0.0.1:8000/qk_deploy/southpark-b/stan19/cartman10/</a></p>
<p>获得结果</p>
<blockquote>
<p>Stan win</p>
</blockquote>
<hr>
<h2 id="结合数据层使用"><a href="#结合数据层使用" class="headerlink" title="结合数据层使用"></a>结合数据层使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test_views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">project_list</span><span class="params">(request)</span>:</span></span><br><span class="line">    p_list = Project.objects.order_by(<span class="string">'project_name'</span>)</span><br><span class="line">    output = <span class="string">', '</span>.join([q.project_name <span class="keyword">for</span> q <span class="keyword">in</span> p_list])</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(output)</span><br><span class="line"></span><br><span class="line"><span class="comment">#urls.py</span></span><br><span class="line">testPatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r'^projectlist/$'</span>,test_views.project_list,name=<span class="string">'project_list'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>访问 <a href="http://127.0.0.1:8000/qk_deploy/projectlist/" target="_blank" rel="noopener">http://127.0.0.1:8000/qk_deploy/projectlist/</a></p>
<p>可以看到打印出了我们已经创建的项目列表</p>
<hr>
<h2 id="加入模版系统"><a href="#加入模版系统" class="headerlink" title="加入模版系统"></a>加入模版系统</h2><p>我们现在已经可以输出我们需要的内容到页面了，但是还不够美观，我们想要输出的是一个页面，而不是简单的字符串。</p>
<p>这时候我们就要用到 Django 的服务端渲染-模版技术</p>
<h3 id="题外话：如果你想使用前后端分离"><a href="#题外话：如果你想使用前后端分离" class="headerlink" title="题外话：如果你想使用前后端分离"></a><strong>题外话：如果你想使用前后端分离</strong></h3><p>现在前后端分离的开发方式比较热门，笔者也研究过 vue.js 前端框架</p>
<p>要实现前后端分离，我们的后端渲染就算是用不上啦，至于业务逻辑，也需要放到前端来处理，view也不用处理业务逻辑了</p>
<p>我们只需要把API接口做好就可以了</p>
<p>我们只需要保留Django的controller部分，也就是urlconf这一块</p>
<p>这样一来做到了前后端分离</p>
<p>二来呢，django可以是很灵活的，同一个网站你可以部分页面采用 vue 部分采用 react，部分用django模版来渲染也行呀~</p>
<p>我们的项目将会基于vue.js 2来进行开发，搭建将在后面的文章中详细解说</p>
<p>在这之前，我们还是先简单讲讲 Django 自身的模版系统</p>
<h3 id="创建模版"><a href="#创建模版" class="headerlink" title="创建模版"></a><strong>创建模版</strong></h3><p>我们在app目录下创建templates目录</p>
<p>模版的具体设置在settings中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.django.DjangoTemplates'</span>,</span><br><span class="line">        <span class="string">'DIRS'</span>: [],</span><br><span class="line">        <span class="string">'APP_DIRS'</span>: <span class="keyword">True</span>,</span><br><span class="line">        <span class="string">'OPTIONS'</span>: &#123;</span><br><span class="line">            <span class="string">'context_processors'</span>: [</span><br><span class="line">                <span class="string">'django.template.context_processors.debug'</span>,</span><br><span class="line">                <span class="string">'django.template.context_processors.request'</span>,</span><br><span class="line">                <span class="string">'django.contrib.auth.context_processors.auth'</span>,</span><br><span class="line">                <span class="string">'django.contrib.messages.context_processors.messages'</span>,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>当 APP_DIRS 为 True 的时候，Django会所有已经安装了的APP目录下的templates中寻找模版</p>
<p>我们继续在templates目录下创建目录qk_deploy目录，并在里面创建project_list.html </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if p_list %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;% for p in p_list %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; p.project_name &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>还没有创建项目<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>修改我们的view</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test_views.py</span></span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> loader</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">project_list</span><span class="params">(request)</span>:</span></span><br><span class="line">    p_list = Project.objects.order_by(<span class="string">'project_name'</span>)</span><br><span class="line">    template = loader.get_template(<span class="string">'qk_deploy/project_list.html'</span>)</span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'p_list'</span>:p_list,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(template.render(context,request))</span><br></pre></td></tr></table></figure>
<p>重新访问 <a href="http://127.0.0.1:8000/qk_deploy/projectlist/" target="_blank" rel="noopener">http://127.0.0.1:8000/qk_deploy/projectlist/</a></p>
<p>我们会发现我们的列表已经按模版的形式重新渲染了</p>
<ul>
<li>项目1</li>
<li>项目2</li>
<li>等等</li>
</ul>
<p>render还可以简写为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">project_list</span><span class="params">(request)</span>:</span></span><br><span class="line">    p_list = Project.objects.order_by(<span class="string">'project_name'</span>)</span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'p_list'</span>:p_list,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(render(request,<span class="string">'qk_deploy/project_list.html'</span>,context))</span><br></pre></td></tr></table></figure>
<h3 id="其他模版相关内容"><a href="#其他模版相关内容" class="headerlink" title="其他模版相关内容"></a>其他模版相关内容</h3><p>我们这里就不赘述其他的 django 模版相关的内容了</p>
<p>有兴趣可以参考 <a href="https://docs.djangoproject.com/en/1.11/intro/tutorial03/" target="_blank" rel="noopener">官方教程</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://Mapz.github.io/2017/05/08/Django项目开发（一）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mapz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/link-300x300.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mapz's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/08/Django项目开发（一）/" itemprop="url">
                  Django项目开发（一）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-08T17:19:10+08:00">
                2017-05-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/08/Django项目开发（一）/" class="leancloud_visitors" data-flag-title="Django项目开发（一）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>原文地址：<a href="https://mapz.github.io/2017/05/08/Django%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80%EF%BC%89/">Mapz的blog</a></p>
<p><strong>这是系列第二篇，第一篇请移步</strong></p>
<p><a href="https://mapz.github.io/2017/05/08/Django%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%90%AD%E5%BB%BA/">Django项目的搭建</a></p>
<p>上一次我们介绍了如何搭建django项目，本次我们继续学习django项目的开发</p>
<hr>
<h2 id="数据库的接入"><a href="#数据库的接入" class="headerlink" title="数据库的接入"></a>数据库的接入</h2><p>我们这里使用mySql数据库</p>
<p>先在虚拟环境中装 pymysql <strong>（MySQLdb在Python3中已经不能用）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pymysql</span><br></pre></td></tr></table></figure>
<p>打开settings.py</p>
<p>修改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="comment"># 'ENGINE': 'django.db.backends.sqlite3',</span></span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>, <span class="comment">#数据库引擎</span></span><br><span class="line">        <span class="comment"># 'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),</span></span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'proj_mgr_kits'</span>, <span class="comment">#你的数据库名称</span></span><br><span class="line">        <span class="string">'USER'</span>:<span class="string">'***'</span>, <span class="comment">#数据库用户</span></span><br><span class="line">        <span class="string">'PASSWORD'</span>:<span class="string">'***'</span>, <span class="comment">#数据库密码</span></span><br><span class="line">        <span class="string">'HOST'</span>:<span class="string">'***'</span>, <span class="comment">#数据库主机</span></span><br><span class="line">        <span class="string">'PORT'</span>:<span class="string">'3306'</span>, <span class="comment">#数据库端口</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>详细修改方式参见 <a href="https://docs.djangoproject.com/en/1.11/ref/settings/" target="_blank" rel="noopener">官网文档</a></p>
<p>另外针对 pymysql 还需要配置站点的__init__.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h2><p>设置时区和语言</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LANGUAGE_CODE = <span class="string">'zh-Hans'</span></span><br><span class="line"></span><br><span class="line">TIME_ZONE = <span class="string">'PRC'</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Django结构简介"><a href="#Django结构简介" class="headerlink" title="Django结构简介"></a>Django结构简介</h2><p>django是一个MVC框架，数据上，使用模型model做ORM映射数据库</p>
<p>view层使用django的模版来做渲染</p>
<p>控制层用灵活的url路由来实现，后面我们陆续来介绍这些内容</p>
<hr>
<h2 id="创建数据库表"><a href="#创建数据库表" class="headerlink" title="创建数据库表"></a>创建数据库表</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>
<p>这个命令会创建所有已安装的APP所需的数据表</p>
<p>所有已经安装的APP被配置在 <strong>settings.py</strong> 的<br><strong>INSTALLED_APPS</strong> 属性下</p>
<hr>
<h2 id="创建model"><a href="#创建model" class="headerlink" title="创建model"></a>创建model</h2><p>Model 是 Django做对象映射的模型，你创建的 Model 类会被diango映射到数据库中</p>
<p>我们创建一个自己的model</p>
<p>修改 models.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    project_name = models.CharField(max_length=<span class="number">50</span>)</span><br></pre></td></tr></table></figure>
<p>Model 支持的数据类型和创建参数参见 <a href="https://docs.djangoproject.com/en/1.11/ref/models/fields/#django.db.models.Field" target="_blank" rel="noopener">官方文档</a></p>
<p>常用的参数比如choices,可以让参数在一个枚举中选择</p>
<p>例如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeployProfile</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    deploy_type_choice = (</span><br><span class="line">        (<span class="string">'Server'</span>,<span class="string">'服务器'</span>), <span class="comment">#第一个参数为数据库保存值，第二个为显示在界面的值</span></span><br><span class="line">        (<span class="string">'CLient'</span>,<span class="string">'客户端'</span>)</span><br><span class="line">    )</span><br><span class="line">    deploy_type = models.CharField(max_length=<span class="number">20</span>, choices=deploy_type_choice, verbose_name=<span class="string">'部署类型'</span>)</span><br></pre></td></tr></table></figure>
<p>其他的类型就不再赘述</p>
<hr>
<h2 id="把我们自己的app加入到项目app中"><a href="#把我们自己的app加入到项目app中" class="headerlink" title="把我们自己的app加入到项目app中"></a>把我们自己的app加入到项目app中</h2><p>编辑settings.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">'xxxxx'</span></span><br><span class="line">    <span class="string">'qk_deploy.apps.QkDeployConfig'</span>,</span><br><span class="line">    <span class="string">'xxxxx'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>重新创建表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations qk_deploy</span><br></pre></td></tr></table></figure>
<p><strong>makemigrations</strong> 命令告诉系统，我的模型已经发生了变化，需要制作一个迁移</p>
<p>迁移做好之后，我们再用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>
<p>重新制作数据表</p>
<hr>
<h2 id="创建管理员"><a href="#创建管理员" class="headerlink" title="创建管理员"></a>创建管理员</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py createsuperuser</span><br></pre></td></tr></table></figure>
<p>然后按提示输入，来创建一个管理员</p>
<p>启动服务器后</p>
<p>进入页面</p>
<p><a href="http://127.0.0.1:8000/admin/" target="_blank" rel="noopener">http://127.0.0.1:8000/admin/</a></p>
<p>就可以用你的管理员来登陆管理界面了</p>
<hr>
<h2 id="把我们的app加入到管理界面中来"><a href="#把我们的app加入到管理界面中来" class="headerlink" title="把我们的app加入到管理界面中来"></a>把我们的app加入到管理界面中来</h2><p>修改app目录下的admin.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># Register your models here.</span></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Project</span><br><span class="line">admin.site.register(Project)</span><br></pre></td></tr></table></figure>
<p>就可以了</p>
<p>register参数也接收一个可迭代容器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin.site.register([Project,p1,p2,p3])</span><br></pre></td></tr></table></figure>
<p>然后我们进入管理页面，发现上面的model已经可以管理了</p>
<p>但是如果我们想有一个自定义的名称，而不是类的名字，怎么办呢？</p>
<p>答案是在model中加上 meta </p>
<p>编辑Project model</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    project_name = models.CharField(max_length=<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">'项目'</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br></pre></td></tr></table></figure>
<p>其中 verbose_name 是显示的名称，而 plural是复数形式，我们中文没有复数形式，所以就直接一样就ok了</p>
<p>双薪管理页面，我们发现管理中显示的内容已经是我们写的’项目’了</p>
<p>至于模型的字段要显示我们想要的名字呢，也是一样的，修改model</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    project_name = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">'项目名称'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">'项目'</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br></pre></td></tr></table></figure>
<p>好奇的同学又要问了，APP名字在管理界面怎么改呀</p>
<p>我们修改apps.py</p>
<p>在QkDeployConfig类下面增加一个属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QkDeployConfig</span><span class="params">(AppConfig)</span>:</span></span><br><span class="line">    name = <span class="string">'qk_deploy'</span></span><br><span class="line">    verbose_name = <span class="string">'部署管理器'</span></span><br></pre></td></tr></table></figure>
<p>刷新管理界面再看看~~</p>
<p>我们用管理工具创建新项目后，新项目在列表里面显示为 project object,这显然不是我们想要的，怎么办咧</p>
<p>为model加上字符串返回函数就可以了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    project_name = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">'项目名称'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.project_name</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">'项目'</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br></pre></td></tr></table></figure>
<p>刷新管理界面，显示的项目已经是我们设定的项目名称了</p>
<hr>
<h2 id="文本编码问题"><a href="#文本编码问题" class="headerlink" title="文本编码问题"></a>文本编码问题</h2><p>如果遇到中文无法录入管理系统的问题，请检查数据库编码是否和程序中一致哦</p>
<p>不一致的话，请先修改数据库编码，然后删除数据表，重新migrate</p>
<hr>
<p>到此，我们的数据库管理功能已经完成，也就是MVC中的M</p>
<p>下次我们继续说MVC中的V ，也就是 view 展示层</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/link-300x300.gif"
               alt="Mapz" />
          <p class="site-author-name" itemprop="name">Mapz</p>
           
              <p class="site-description motion-element" itemprop="description">FIND THE CHILD</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Mapz" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mapz</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("r1k7xXPTo8S7UTzLv0ny4XLz-gzGzoHsz", "3QFN4XJbJvVAywXDtWKYeUV4");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

</body>
</html>
